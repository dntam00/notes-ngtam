<html>

<head>
  <title>gRPC Load balancing (2) - Client architecture | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script src="../js/toc.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container has-toc navigation-box">
            <p><a href="/">&larr; Quay v·ªÅ trang ch·ªß</a></p>
        </div>
  <div class="container has-toc">
    <div class="table-of-contents">
        <div class="toc-title">Table of Contents</div>
        <ul class="toc-list">  <li><a href="#core-component" class="toc-link toc-level-2"><span class="toc-hash">#</span> Core component</a></li>
  <li><a href="#resolver" class="toc-link toc-level-2"><span class="toc-hash">#</span> Resolver</a></li>
  <li><a href="#balancer" class="toc-link toc-level-2"><span class="toc-hash">#</span> Balancer</a></li>
  <li><a href="#v-d" class="toc-link toc-level-2"><span class="toc-hash">#</span> V√≠ d·ª•</a></li>
  <li><a href="#tng-kt" class="toc-link toc-level-2"><span class="toc-hash">#</span> T·ªïng k·∫øt</a></li>
  <li><a href="#m-ngun" class="toc-link toc-level-2"><span class="toc-hash">#</span> M√£ ngu·ªìn</a></li>
  <li><a href="#tham-kho" class="toc-link toc-level-2"><span class="toc-hash">#</span> Tham kh·∫£o</a></li></ul>
    </div>
    <div class="main">
      <h1>gRPC Load balancing (2) - Client architecture</h1>
      <p>Ti·∫øp n·ªëi chu·ªói b√†i vi·∫øt v·ªÅ c√¢n b·∫±ng t·∫£i <code>gRPC</code>, h√¥m nay m√¨nh s·∫Ω t√¨m hi·ªÉu v·ªÅ c√°c th√†nh ph·∫ßn ·ªü <code>gRPC client</code>, ƒë·∫∑c bi·ªát l√† nh·ªØng th√†nh ph·∫ßn li√™n quan ƒë·∫øn c√¢n b·∫±ng t·∫£i.</p>
<h2><a href="#core-component" aria-hidden="true" class="anchor" id="core-component"></a>Core component</h2>
<ul>
<li><code>Stub</code>: client-facing interface, gi√∫p ch√∫ng ta c√≥ c·∫£m gi√°c g·ªçi m·ªôt h√†m ·ªü remote nh∆∞ ·ªü local.</li>
<li><code>Client connection</code>: &quot;virtual connection&quot; ƒë·∫øn m·ªôt endpoint, qu·∫£n l√Ω m·ªôt ho·∫∑c nhi·ªÅu connection th·∫≠t ƒë·∫øn c√°c gRPC servers (cho ph√©p hi·ªán th·ª±c client-side load balancing) v√† cung c·∫•p c√°c t√≠nh nƒÉng nh∆∞ ph√¢n gi·∫£n domain name, TLS handshake, reconnect,.. th√¥ng qua c√°c module kh√°c.</li>
<li><code>Resolver</code>: ph√¢n gi·∫£n domain name, ngo√†i vi·ªác cung c·∫•p c√°c c∆° ch·∫ø c√≥ s·∫µn nh∆∞ <code>passthrough</code> (connect th·∫≥ng t·ªõi server), <code>dns</code> (ph√¢n gi·∫£i domain name ƒë·ªÉ l·∫•y danh s√°ch server) hay <code>xDS</code> th√¨ <code>resolver</code> c√≤n cho ph√©p ng∆∞·ªùi d√πng s·ª≠ d·ª•ng c√°c logic kh√°c nh∆∞ k·∫øt h·ª£p v·ªõi external service discovery.</li>
<li><code>Load balancer</code>: hi·ªán th·ª±c c√¢n b·∫±ng t·∫£i ·ªü ph√≠a client, c√°c c∆° ch·∫ø c√≥ s·∫µn ƒë√£ ƒë∆∞·ª£c hi·ªán th·ª±c ·ªü <code>Go</code> nh∆∞: <code>pick first</code>, <code>round robin</code>, <code>weighted round robin</code>, <code>least request</code>,... Gi·ªëng v·ªõi <code>resolver</code>, gRPC c≈©ng h·ªó tr·ª£ ng∆∞·ªùi d√πng custom logic ƒë·ªÉ hi·ªán th·ª±c c√°c thu·∫≠t to√°n c√¢n b·∫±ng t·∫£i ph·ª©c t·∫°p.</li>
<li><code>Interceptor</code>: cung c·∫•p kh·∫£ nƒÉng can thi·ªáp v√†o request tr∆∞·ªõc khi g·ª≠i ƒëi.</li>
</ul>
<h2><a href="#resolver" aria-hidden="true" class="anchor" id="resolver"></a>Resolver</h2>
<p><code>Resolver</code> v·ªÅ c∆° b·∫£n l√† m·ªôt service discovery, khi client mu·ªën g·ª≠i request, n√≥ ph·∫£i bi·∫øt ƒë∆∞·ª£c ƒë·ªãa ch·ªâ c·ªßa server. Hi·ªán t·∫°i gRPC cung c·∫•p m·ªôt s·ªë c∆° ch·∫ø c√≥ s·∫µn ƒë·ªÉ s·ª≠ d·ª•ng:</p>
<ul>
<li><code>pass through</code>: s·ª≠ d·ª•ng ƒë·ªãa ch·ªâ server ƒë∆∞·ª£c cung c·∫•p, ƒë∆∞·ª£c s·ª≠ d·ª•ng khi k·∫øt tr·ª±c ti·∫øp ƒë·∫øn load balancer ho·∫∑c 1 server.</li>
<li><code>dns</code>: ph√¢n gi·∫£i ƒë·ªãa ch·ªâ ƒë∆∞·ª£c cung c·∫•p ƒë·ªÉ l·∫•y ƒë∆∞·ª£c danh s√°ch t·∫•t c·∫£ servers, v√≠ d·ª•: client c√≥ th·ªÉ s·ª≠ d·ª•ng resolver n√†y khi c·ª•m server ƒë·ª©ng sau <code>headless service</code> c·ªßa K8s.</li>
<li><code>unix</code>: s·ª≠ d·ª•ng cho unix file system.</li>
</ul>
<p>B√™n c·∫°nh nh·ªØng c∆° ch·∫ø <code>resolver</code> m·∫∑c ƒë·ªãnh, gRPC c√≤n cung c·∫•p API ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ t·ª± hi·ªán th·ª±c, qu√° tr√¨nh ƒëƒÉng k√≠ v√† s·ª≠ d·ª•ng nh∆∞ sau:</p>
<p><img src="img/grpc-resolver.png" alt="grpc-resolver" /></p>
<ul>
<li>ƒêƒÉng k√≠ custom resolver v·ªõi gRPC, m·ªói resolver s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh danh b·ªüi m·ªôt <code>scheme</code>.</li>
<li>T·∫°o gRPC client v·ªõi target c√≥ ch·ª©a scheme ·ªü tr√™n.</li>
<li>gRPC s·∫Ω parse target r·ªìi l·∫•y ra resolver t∆∞∆°ng ·ª©ng v·ªõi scheme.</li>
<li>Ph√¢n t·∫£i ƒë·ªãa ch·ªâ c·ªßa servers d·ª±a v√†o logic ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.</li>
<li>Theo d√µi v√† c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ c·ªßa servers khi c√≥ s·ª± thay ƒë·ªïi.</li>
</ul>
<h2><a href="#balancer" aria-hidden="true" class="anchor" id="balancer"></a>Balancer</h2>
<p><code>Balancer</code> hi·ªán th·ª±c client-side load balancing cho gRPC client, ·ªü ph·∫ßn tr∆∞·ªõc, m√¨nh c√≥ m√¥ t·∫£ v·ªÅ <code>Client connection</code>, gRPC s·ª≠ d·ª•ng <code>virtual connection</code> n√†y ƒë·ªÉ qu·∫£n l√Ω c√°c connection th·ª±c s·ª± ƒë·∫øn servers, th√¥ng qua ƒë√≥ ƒë·ªÉ qu·∫£n l√Ω vi·ªác ph√¢n gi·∫£i ƒë·ªãa ch·ªâ, kh·ªüi t·∫°o k·∫øt n·ªëi, c·∫≠p nh·∫≠t tr·∫°ng th√°i v√† <strong>c√¢n b·∫±ng t·∫£i</strong>.</p>
<p>Gi·ªëng nh∆∞ <code>resolver</code>, b√™n c·∫°nh cung c·∫•p c√°c thu·∫≠t to√°n c√¢n b·∫±ng t·∫£i ph·ªï bi·∫øn, gRPC c≈©ng cho ph√©p ng∆∞·ªùi ƒëƒÉng k√≠ c√°c thu·∫≠t to√°n tu·ª≥ ch·ªânh, qu√° tr√¨nh ƒëƒÉng k√≠ v√† s·ª≠ d·ª•ng gi·ªëng v·ªõi <code>resolver</code>.</p>
<p><img src="img/grpc-balancer.png" alt="grpc-resolver" /></p>
<h2><a href="#v√≠-d·ª•" aria-hidden="true" class="anchor" id="v√≠-d·ª•"></a>V√≠ d·ª•</h2>
<p>M√¨nh s·∫Ω hi·ªán th·ª±c m·ªôt custom resovler b·∫±ng <code>Go</code> ƒë·ªÉ l√†m r√µ h∆°n ph·∫ßn l√Ω thuy·∫øt ·ªü ph·∫ßn tr∆∞·ªõc.</p>
<ul>
<li>c√≥ 3 gRPC servers ch·∫°y ·ªü local.</li>
<li>scheme c·ªßa resolver l√† <code>static</code>, n√≥ ch·ªâ ƒë∆°n gi·∫£n parse ƒë·ªãa ch·ªâ c·ªßa c√°c server t·ª´ chu·ªói string.</li>
</ul>
<p>Ph·∫ßn code ƒë·ªãnh nghƒ©a <code>builder</code> v√† ƒëƒÉng k√≠ t·ªõi <code>gRPC</code>.</p>
<pre><code class="language-go">func init() {
	resolver.Register(&amp;StaticBuilder{})
}

type StaticBuilder struct{}

func (sb *StaticBuilder) Build(target resolver.Target, cc resolver.ClientConn,
	opts resolver.BuildOptions) (resolver.Resolver, error) {
	endpoints := strings.Split(target.Endpoint(), &quot;,&quot;)

	r := &amp;StaticResolver{
		endpoints: endpoints,
		cc:        cc,
	}
	r.ResolveNow(resolver.ResolveNowOptions{})
	return r, nil
}

func (sb *StaticBuilder) Scheme() string {
	return &quot;static&quot;
}
</code></pre>
<p>Ph·∫ßn code ƒë·ªãnh nghƒ©a <code>static resolver</code>.</p>
<pre><code class="language-go">type StaticResolver struct {
	endpoints []string
	cc        resolver.ClientConn
	sync.Mutex
}

func (r *StaticResolver) ResolveNow(opts resolver.ResolveNowOptions) {
	r.Lock()
	r.doResolve()
	r.Unlock()
}

func (r *StaticResolver) Close() {
}

func (r *StaticResolver) doResolve() {
	var addrs []resolver.Address
	for i, addr := range r.endpoints {
		addrs = append(addrs, resolver.Address{
			Addr:       addr,
			ServerName: fmt.Sprintf(&quot;instance-%d&quot;, i+1),
		})
	}

	newState := resolver.State{
		Addresses: addrs,
	}

	_ = r.cc.UpdateState(newState)
}
</code></pre>
<p>Kh·ªüi t·∫°o client s·ª≠ d·ª•ng <code>static scheme</code>.</p>
<pre><code class="language-go">
const (
	target = &quot;static:///127.0.0.1:50051,127.0.0.1:50052,127.0.0.1:50053&quot;
)

func main() {
    conn, err := grpc.NewClient(target, 
                    grpc.WithTransportCredentials(insecure.NewCredentials()),
                    grpc.WithDefaultServiceConfig(`{&quot;loadBalancingConfig&quot;: [{&quot;round_robin&quot;:{}}]}`))
}
</code></pre>
<p>K·∫øt qu·∫£ ch·∫°y ch∆∞∆°ng tr√¨nh:</p>
<p><img src="img/grpc-static-resolver-result.png" alt="grpc-static-resolver-result.png" /></p>
<h2><a href="#t·ªïng-k·∫øt" aria-hidden="true" class="anchor" id="t·ªïng-k·∫øt"></a>T·ªïng k·∫øt</h2>
<p>Th√¥ng qua b√†i vi·∫øt n√†y, ch√∫ng ta ƒë√£ t√¨m hi·ªÉu v·ªÅ ki·∫øn tr√∫c c·ªßa <code>gRPC client</code>, bi·∫øt ƒë∆∞·ª£c nh·ªØng th√†nh ph·∫ßn v√† c√°ch ch√∫ng ho·∫°t ƒë·ªông v√† t∆∞∆°ng t√°c v·ªõi nhau:</p>
<ul>
<li><code>Resolver</code>: ph√¢n gi·∫£i targer ƒë·ªÉ l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ c√°c <code>gRPC servers</code>.</li>
<li><code>Blanacer</code>: c√¢n b·∫±ng t·∫£i ·ªü ph√≠a client.</li>
</ul>
<p>ƒëi·ªÅu n√†y s·∫Ω gi√∫p ch√∫ng ta s·ª≠ d·ª•ng gRPC d·ªÖ d√†ng h∆°n, ƒë·∫∑t n·ªÅn t·∫£ng ƒë·ªÉ c√≥ th·ªÉ tri·ªÉn khai c√°c m√¥ h√¨nh ph·ª©c t·∫°p h∆°n ·ªü c√°c b√†i sau.</p>
<h2><a href="#m√£-ngu·ªìn" aria-hidden="true" class="anchor" id="m√£-ngu·ªìn"></a>M√£ ngu·ªìn</h2>
<p>B·∫°n c√≥ th·ªÉ tham kh·∫£o v√† tu·ª≥ ch·ªânh m√£ ngu·ªìn ·ªü repository <a href="https://github.com/dntam00/grpc-loadbalancing/tree/main/static-resolver">grpc-loadbalancing</a></p>
<h2><a href="#tham-kh·∫£o" aria-hidden="true" class="anchor" id="tham-kh·∫£o"></a>Tham kh·∫£o</h2>
<ul>
<li><a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md">Load Balancing in gRPC</a></li>
<li><a href="https://github.com/grpc/proposal/blob/master/A27-xds-global-load-balancing.md">A27: xDS-Based Global Load Balancing</a></li>
<li><a href="https://grpc.io/docs/guides/custom-name-resolution/">Custom Name Resolution</a></li>
<li><a href="https://www.sobyte.net/post/2022-03/golang-grpc/">gRPC client</a></li>
</ul>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/networking.html'>networking</a><a class='topic-tag' href='/tags/gRPC.html'>gRPC</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>