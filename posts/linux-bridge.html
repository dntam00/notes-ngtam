<html>

<head>
  <title>Networking (4) Virtual bridge | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container">
    <div class="main">
      <p><a href="/">&lt;- Quay v·ªÅ trang ch·ªß</a></p>
      <h1>Networking (4) Virtual bridge</h1>
      <p>·ªû b√†i tr∆∞·ªõc, m√¨nh ƒë√£ t√¨m hi·ªÉu v·ªÅ <code>network namepsace</code> v√† <code>virtual ethernet</code>, h√¥m nay m√¨nh s·∫Ω ti·∫øp t·ª•c t√¨m hi·ªÉu v·ªÅ m·ªôt thi·∫øt b·ªã m·∫°ng ·∫£o quan tr·ªçng kh√°c, ƒë√≥ l√† <code>bridge</code>.</p>
<h2><a href="#bridge" aria-hidden="true" class="anchor" id="bridge"></a>Bridge</h2>
<p><code>Bridge</code> l√† m·ªôt thi·∫øt b·ªã m·∫°ng ·∫£o (virtual network device), c≈©ng gi·ªëng nh∆∞ <code>veth</code> m√¨nh ƒë√£ t√¨m hi·ªÉu ·ªü b√†i tr∆∞·ªõc, m·∫∑c ƒë·ªãnh, <code>bridge</code> ho·∫°t ƒë·ªông ·ªü layer 2 (m√¥ h√¨nh OSI), v√† c√≥ ch·ª©c nƒÉng t∆∞∆°ng t·ª± nh∆∞ m·ªôt switch (k·∫øt n·ªëi c√°c m√°y t√≠nh ·ªü c√πng m·∫°ng LAN). Tuy nhi√™n, khi ƒë∆∞·ª£c g√°n cho ƒë·ªãa ch·ªâ IP, n√≥ c≈©ng c√≥ th·ªÉ ho·∫°t ƒë·ªông ·ªü layer 3.</p>
<p><code>Bridge</code> k·∫øt n·ªëi v√†o <code>network protocol stack</code> (m√¨nh s·∫Ω d√πng <code>NPS</code> ƒë·ªÉ ch·ªâ c·ª•m t·ª´ n√†y trong xuy√™n su·ªët b√†i vi·∫øt) v√† gi·ªëng nh∆∞ switch, n√≥ c√≥ c√°c c·ªïng ƒë·ªÉ c√°c thi·∫øt b·ªã m·∫°ng ·∫£o kh√°c c√≥ th·ªÉ k·∫øt n·ªëi v√†o nh∆∞ <code>veth</code>, <code>tap</code>,...</p>
<p><img src="img/bridge-linux.png" alt="bridge-linux" /></p>
<p>Trong linux, ch√∫ng ta c√≥ th·ªÉ d√πng l·ªánh <code>ip</code> ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi c√°c thi·∫øt b·ªã m·∫°ng ·∫£o, h√£y c√πng t·∫°o ra m√¥ h√¨nh nh∆∞ ·∫£nh tr√™n.</p>
<pre><code class="language-bash">ip link add br0 type bridge
ip link set br0 up

ip link add veth0 type veth peer name veth1
ip addr add 20.1.0.10/24 dev veth0
ip addr add 20.1.0.11/24 dev veth1
ip link set veth0 up
ip link set veth1 up
ip link set dev veth0 master br0
# verify result
bridge link
brctl show
</code></pre>
<p>K·∫øt qu·∫£ c√≥ ƒë∆∞·ª£c sau khi ch·∫°y c√°c c√¢u l·ªánh tr√™n:</p>
<pre><code># bridge link
6: veth0@veth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master br0 state forwarding priority 32 cost 2
# brctl show
bridge name	bridge id		STP enabled	interfaces
br0		8000.8e5ec2c9742a	no		veth0
</code></pre>
<p>·ªû b√†i vi·∫øt v·ªÅ <a href="https://notes-ngtam.pages.dev/posts/virtual-ethernet">veth</a>, sau khi t·∫°o 2 virtual ethernet th√¨ <code>veth0</code> s·∫Ω c√≥ 1 ƒë·∫ßu k·∫øt n·ªëi v·ªõi <code>NPS</code> v√† ƒë√¢y l√† m·ªôt giao ti·∫øp 2 chi·ªÅu. ·ªû m√¥ h√¨nh tr√™n, m√¨nh k·∫øt n·ªëi <code>veth0</code> v√†o <code>br0</code>, v·∫≠y h√£y xem th·ª≠ c√≥ g√¨ ƒëi·ªÅu kh√°c nhau b·∫±ng l·ªánh <code>ping</code> (l∆∞u √Ω ƒë·ªÉ <code>arp protocol</code> c√≥ th·ªÉ ho·∫°t ƒë·ªông th√¨ b·∫°n ph·∫£i c·∫•u h√¨nh network nh∆∞ ·ªü b√†i <a href="https://notes-ngtam.pages.dev/posts/virtual-ethernet">veth</a>).</p>
<pre><code class="language-bash">ping -c 1 -I veth0 20.1.0.11
</code></pre>
<p>S·ª≠ d·ª•ng <code>tcpdump</code> ƒë·ªÉ b·∫Øt g√≥i tin tr√™n t·∫•t c·∫£ <code>network interface</code>:</p>
<pre><code class="language-bash">tcpdump -n -i any
</code></pre>
<p>K·∫øt qu·∫£ c·ªßa l·ªánh <code>ping</code> v√† <code>tcpdump</code> nh∆∞ sau:</p>
<pre><code># ping
PING 20.1.0.11 (20.1.0.11) from 20.1.0.10 veth0: 56(84) bytes of data.
From 20.1.0.10 icmp_seq=1 Destination Host Unreachable
--- 20.1.0.11 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms


# tcpdump
11:05:40.901664 veth0 Out ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length 28
11:05:40.901671 veth1 B   ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length 28
11:05:40.901697 veth1 Out ARP, Reply 20.1.0.11 is-at de:9a:36:c3:48:93, length 28
11:05:40.901698 veth0 In  ARP, Reply 20.1.0.11 is-at de:9a:36:c3:48:93, length 28
11:05:40.901698 br0   In  ARP, Reply 20.1.0.11 is-at de:9a:36:c3:48:93, length 28
</code></pre>
<p>L·∫ßn n√†y, g√≥i tin <code>ARP</code> ƒë∆∞·ª£c g·ª≠i ƒëi t·ª´ <code>veth0</code> t·ªõi <code>veth1</code> v√† c√≥ ph·∫£n h·ªìi, tuy nhi√™n thay v√¨ g√≥i tin ph·∫£n h·ªìi ƒëi tr·ªü l·∫°i <code>NPS</code> th√¨ n√≥ ƒëi v√†o <code>br0</code>, k·∫øt qu·∫£ l√† <code>NPS</code> kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ MAC c·ªßa <code>veth1</code> ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng mapping <code>MAC address - IP address</code> cho <code>veth0</code>, m√† th√¥ng tin n√†y s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ·ªü <code>br0</code>, s·ª≠ d·ª•ng l·ªánh <code>arp -n</code> v√† <code>brctl showmacs br0</code> ƒë·ªÉ ki·ªÉm ch·ª©ng l·∫°i v√† nh·∫≠n ƒë∆∞·ª£c k·∫øt qu·∫£:</p>
<pre><code># arp -n

Address                  HWtype  HWaddress           Flags Mask            Iface
172.17.0.2               ether   02:42:ac:11:00:02   C                     eth0
20.1.0.11                        (incomplete)                              veth0
172.17.0.1               ether   02:42:9e:e4:b1:d5   C                     eth0
20.1.0.10                ether   8e:5e:c2:c9:74:2a   C                     veth1


# brctl showmacs br0 -&gt; mac address de:9a:36:c3:48:93 c·ªßa veth1

port no mac addr                is local?       ageing timer
  1     8e:5e:c2:c9:74:2a       yes                0.00
  1     8e:5e:c2:c9:74:2a       yes                0.00
  1     de:9a:36:c3:48:93       no                 3.38
</code></pre>
<p>ƒê·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c l·ªánh <code>ping</code> ·ªü tr√™n th√¥ng qua <code>br0</code>, ta ph·∫£i g√°n ƒë·ªãa ch·ªâ <code>ip</code> cho <code>br0</code> thay v√¨ <code>veth0</code>, l√∫c n√†y <code>br0</code> s·∫Ω c√≥ th√™m vai tr√≤ routing thay v√¨ ch·ªâ ƒë∆°n thu·∫ßn l√† m·ªôt virtual switch.</p>
<pre><code class="language-bash">ip addr del 20.1.0.10/24 dev veth0
ip addr add 20.1.0.10/24 dev br0
</code></pre>
<p>Ch·∫°y l·∫°i l·ªánh <code>ping</code> v√† <code>tcpdump</code>:</p>
<pre><code class="language-bash">ping -c 1 -I br0 20.1.0.11
</code></pre>
<p>Ta ƒë∆∞·ª£c k·∫øt qu·∫£:</p>
<pre><code># ping

PING 20.1.0.11 (20.1.0.11) from 20.1.0.10 br0: 56(84) bytes of data.
64 bytes from 20.1.0.11: icmp_seq=1 ttl=64 time=0.717 ms

--- 20.1.0.11 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.717/0.717/0.717/0.000 ms

# tcpdump

12:00:17.086571 br0   Out ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length 28
12:00:17.086611 veth0 Out ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length 28
12:00:17.086616 veth1 B   ARP, Request who-has 20.1.0.11 tell 20.1.0.10, length 28
12:00:17.086865 veth1 Out ARP, Reply 20.1.0.11 is-at de:9a:36:c3:48:93, length 28
12:00:17.086867 veth0 In  ARP, Reply 20.1.0.11 is-at de:9a:36:c3:48:93, length 28
12:00:17.086867 br0   In  ARP, Reply 20.1.0.11 is-at de:9a:36:c3:48:93, length 28
12:00:17.086944 br0   Out IP 20.1.0.10 &gt; 20.1.0.11: ICMP echo request, id 106, seq 1, length 64
12:00:17.086947 veth0 Out IP 20.1.0.10 &gt; 20.1.0.11: ICMP echo request, id 106, seq 1, length 64
12:00:17.086948 veth1 In  IP 20.1.0.10 &gt; 20.1.0.11: ICMP echo request, id 106, seq 1, length 64
12:00:17.087104 lo    In  IP 20.1.0.11 &gt; 20.1.0.10: ICMP echo reply, id 106, seq 1, length 64
</code></pre>
<p><code>NPS</code> nh·∫≠n ƒë∆∞·ª£c <code>ARP reply</code> v√† n·∫øu s·ª≠ d·ª•ng <code>arp -n</code> ƒë·ªÉ xem l·∫°i k·∫øt qu·∫£, ch√∫ng ta s·∫Ω th·∫•y b·∫£n ghi c·ªßa <code>veth1</code> ·ªü <code>br0</code>:</p>
<pre><code>Address               HWtype  HWaddress           Flags Mask     Iface
20.1.0.11             ether   de:9a:36:c3:48:93   C              br0
172.17.0.1            ether   02:42:9e:e4:b1:d5   C              eth0
20.1.0.10             ether   8e:5e:c2:c9:74:2a   C              veth1
</code></pre>
<p>H√£y quay l·∫°i v√≠ d·ª• l√∫c m√† m√¨nh ch∆∞a thi·∫øt l·∫≠p ƒë·ªãa ch·ªâ IP cho <code>br0</code>, n√≥ s·∫Ω l√† m·ªôt thi·∫øt b·ªã ho·∫°t ƒë·ªông ƒë∆°n thu·∫ßn ·ªü <code>layer 2</code> v·ªõi c√°c <code>ethernet frame</code>, kh√¥ng c√≥ s·ª± li√™n k·∫øt tr·ª±c ti·∫øp ƒë·∫øn <code>NPS</code> (<code>layer 3</code>) th√¥ng qua routing, n√™n l√∫c n√†y c√°c k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß v·∫≠t l√Ω b·∫±ng ƒë·ªãa ch·ªâ IP th√¥ng qua <code>virtual bridge</code> l√† kh√¥ng th·ªÉ x·∫£y ra.</p>
<h2><a href="#·ª©ng-d·ª•ng" aria-hidden="true" class="anchor" id="·ª©ng-d·ª•ng"></a>·ª®ng d·ª•ng</h2>
<h3><a href="#virtual-machine" aria-hidden="true" class="anchor" id="virtual-machine"></a>Virtual machine</h3>
<p><img src="img/bridge-vm.png" alt="bridge-vm" /></p>
<p>M√¥ h√¨nh network c∆° b·∫£n c·ªßa VM ƒë√≥ l√† c√°c NIC trong VM s·∫Ω k·∫øt n·ªëi v·ªõi <code>tun/tap</code> device v√† ƒëi qua <code>br0</code>, l√∫c n√†y <code>br0</code> ƒë√≥ng vai tr√≤ nh∆∞ 1 <code>switch layer 2</code>. N·∫øu mu·ªën VM giao ti·∫øp ƒë∆∞·ª£c v·ªõi m√°y ch·ªß, ch√∫ng ta ph·∫£i c·∫•u h√¨nh th√™m ƒë·ªãa ch·ªâ IP cho <code>br0</code> v√† n√≥ s·∫Ω c√≥ th√™m vai tr√≤ l√† 1 <code>gateway</code>.</p>
<h3><a href="#docker-container" aria-hidden="true" class="anchor" id="docker-container"></a>Docker container</h3>
<p><code>Bridge</code> ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ driver m·∫∑c ƒë·ªãnh trong docker, cung c·∫•p s·ª± giao ti·∫øp cho c√°c container ch·∫°y tr√™n c√πng 1 m√°y ch·ªß v·∫≠t l√Ω, m√¥ h√¨nh ho·∫°t ƒë·ªông nh∆∞ sau:</p>
<p><img src="img/docker-container.png" alt="bridge-linux" /></p>
<p>·ªû b√†i vi·∫øt ti·∫øp theo m√¨nh s·∫Ω ph√¢n t√≠ch chi ti·∫øt h∆°n v·ªÅ m√¥ h√¨nh n√†y v√† c√°ch docker d√πng <code>port forwarding</code> b·∫±ng <code>iptables</code>.</p>
<h2><a href="#t·ªïng-k·∫øt" aria-hidden="true" class="anchor" id="t·ªïng-k·∫øt"></a>T·ªïng k·∫øt</h2>
<p>B√†i vi·∫øt n√†y m√¨nh ƒë√£ t√¨m hi·ªÉu qua m·ªôt thi·∫øt b·ªã m·∫°ng ·∫£o quan tr·ªçng ƒë√≥ l√† <code>bridge</code>, c√°ch n√≥ ho·∫°t ƒë·ªông ·ªü <code>layer 2</code> v√† <code>layer 3</code> c≈©ng nh∆∞ m·ªôt s·ªë ·ª©ng d·ª•ng trong th·ª±c t·∫ø.</p>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/docker.html'>docker</a><a class='topic-tag' href='/tags/networking.html'>networking</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>