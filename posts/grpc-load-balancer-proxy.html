<html>

<head>
  <title>gRPC Load balancing - Proxy | Tam's Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <link href="../css/theme.css?t=" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <script src="../js/highlight.pack.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Tam's Blog</span></a>
  </div>
  <div class="container">
    <div class="main">
      <p><a href="/">&lt;- Quay v·ªÅ trang ch·ªß</a></p>
      <h1>gRPC Load balancing - Proxy</h1>
      <p>Khi th·ªã tr∆∞·ªùng c√≥ xu h∆∞·ªõng chuy·ªÉn d·∫ßn t·ª´ monolithic sang microservice, b√†i to√°n giao ti·∫øp gi·ªØa c√°c service tr·ªü n√™n r·∫•t quan tr·ªçng, v·ªõi nh·ªØng service th√¥ng th∆∞·ªùng hi·ªán nay, m√¨nh th·∫•y c√≥ 3 c√°ch giao ti·∫øp ch√≠nh:</p>
<ul>
<li>HTTP APIs</li>
<li>gRPC</li>
<li>Message queue</li>
</ul>
<p>Khi tri·ªÉn khai h·ªá th·ªëng c·∫ßn x·ª≠ l√Ω m·ªôt l∆∞·ª£ng t·∫£i l·ªõn, m·ªói lo·∫°i service s·∫Ω c·∫ßn ph·∫£i ch·∫°y r·∫•t nhi·ªÅu instance, v·∫≠y b√†i to√°n ƒë·∫∑t ra l√†m th·∫ø n√†o ƒë·ªÉ chia t·∫£i gi·ªØa c√°c instance? ƒê·ªô hi·ªáu qu·∫£ c≈©ng nh∆∞ chi ph√≠ c√†i ƒë·∫∑t, b·∫£o tr√¨ nh∆∞ th·∫ø n√†o? Ph∆∞∆°ng ph√°p √°p d·ª•ng cho m·ªói protocol c√≥ kh√°c nhau kh√¥ng?</p>
<p>ƒê·ªÉ tr·∫£ l·ªùi nh·ªØng c√¢u h·ªèi tr√™n, m√¨nh s·∫Ω vi·∫øt m·ªôt chu·ªói b√†i t√¨m hi·ªÉu v·ªÅ c√°c ph∆∞∆°ng ph√°p load balacing cho gRPC protocol.</p>
<h2><a href="#ph∆∞∆°ng-ph√°p" aria-hidden="true" class="anchor" id="ph∆∞∆°ng-ph√°p"></a>Ph∆∞∆°ng ph√°p</h2>
<p>Hi·ªán t·∫°i c√≥ m·ªôt v√†i ph∆∞∆°ng ph√°p ph·ªï bi·∫øn ƒë·ªÉ x·ª≠ l√Ω grPC load balancing:</p>
<ul>
<li><strong>Proxy load balancing</strong>: l√† ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng, LB s·∫Ω ƒë√≥ng vai tr√≤ nh∆∞ m·ªôt reverse proxy, HAProxy, Nginx, LB c·ªßa cloud provider,... l√† c√°c v√≠ d·ª•.</li>
<li><strong>Client side load balancing</strong>: ph√≠a client ch·ªß ƒë·ªông qu·∫£n l√Ω connection c≈©ng nh∆∞ c∆° ch·∫ø load balancing, c√≥ th·ªÉ t·ª± custom ho√†n to√†n d·ª±a tr√™n c√°c specification c·ªßa gRPC ho·∫∑c k·∫øt h·ª£p v·ªõi ZooKeeper/Etcd/Consul,...</li>
<li><strong>Look-aside load balancing</strong>: c√≥ m·ªôt external load balancing component ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω c√°c servers (service discovery) v√† tr·∫£ l·ªùi th√¥ng tin cho client m·ªói khi ƒë∆∞·ª£c y√™u c·∫ßu.</li>
<li><strong>Service mesh</strong>: s·ª≠ d·ª•ng c√°c load balancer c√≥ s·∫µn trong c√°c proxy nh∆∞ Istio, Envoy,...</li>
</ul>
<p>M·ªói ph∆∞∆°ng ph√°p s·∫Ω c√≥ ∆∞u nh∆∞·ª£c ƒëi·ªÉm ri√™ng c≈©ng nh∆∞ chi ph√≠ c√†i ƒë·∫∑t, b·∫£o tr√¨ kh√°c nhau, b√†i ƒë·∫ßu ti√™n n√†y m√¨nh s·∫Ω n√≥i v·ªÅ ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng, d√πng load balancer nh∆∞ m·ªôt proxy.</p>
<h2><a href="#grpc-load-balancing" aria-hidden="true" class="anchor" id="grpc-load-balancing"></a>gRPC load balancing</h2>
<p>Tr∆∞·ªõc ti√™n, h√£y c√πng m√¨nh ph√¢n t√≠ch m·ªôt v√†i l∆∞u √Ω v·ªÅ gRPC load balancing.</p>
<p>gRPC l√† giao th·ª©c s·ª≠ d·ª•ng <code>HTTP/2</code>, c√≥ c∆° ch·∫ø multiplex nhi·ªÅu request/response d·ª±a tr√™n c√πng 1 connection, v√¨ v·∫≠y kh√°c v·ªõi HTTP APIs d·ª±a tr√™n <code>HTTP/1.1</code>, ·ªü gRPC, ch√∫ng ta s·∫Ω n√≥i ƒë·∫øn chuy·ªán load balancing connection thay v√¨ request. M·ªói khi tcp connection ƒë∆∞·ª£c thi·∫øt l·∫≠p t·ªõi m·ªôt backend server th√¨ t·∫•t c·∫£ nh·ªØng request ƒë∆∞·ª£c th·ª±c hi·ªán tr√™n connection ƒë√≥ s·∫Ω ch·ªâ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi m·ªôt backend server, t·∫•t c·∫£ server c√≤n l·∫°i ng·ªìi ch∆°i. V·∫≠y √Ω t∆∞·ªüng chung ƒë√≥ l√† c√≥ nhi·ªÅu client v√† m·ªói client s·ª≠ d·ª•ng pool technique ƒë·ªÉ t·∫£i ƒë∆∞·ª£c chia ƒë·ªÅu ra t·∫•t c·∫£ backend server.</p>
<h2><a href="#proxy-load-balancing" aria-hidden="true" class="anchor" id="proxy-load-balancing"></a>Proxy load balancing</h2>
<p>ƒê√¢y l√† m·ªôt ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng v√† d·ªÖ c√†i ƒë·∫∑t nh·∫•t, ch√∫ng ta c·∫ßn m·ªôt load balancer ƒë·ª©ng gi·ªØa client v√† server, c√≥ nhi·ªÅu ·ª©ng vi√™n c√≥ th·ªÉ l√†m ƒë∆∞·ª£c vi·ªác n√†y m·ªôt c√°ch hi·ªáu qu·∫£, v√≠ d·ª•:</p>
<ul>
<li>HAProxy</li>
<li>Nginx</li>
<li>LB c·ªßa c√°c cloud provider</li>
</ul>
<p><img src="img/lb-proxy.png" alt="lb-proxy" /></p>
<p>Client s·∫Ω t·∫°o connection t·ªõi load balancer v√† load balancer s·∫Ω t·∫°o connection t·ªõi server d·ª±a tr√™n c∆° ch·∫ø load balancing ƒë∆∞·ª£c thi·∫øt l·∫≠p, v·ªõi c√°ch ho·∫°t ƒë·ªông n√†y, ch√∫ng ta c·∫ßn thi·∫øt l·∫≠p 2 connection ƒë·ªÉ c√≥ ƒë∆∞·ª£c 1 <em><strong>client-server connection</strong></em>, ƒë√≥ ƒë√≥, client th·ª±c ch·∫•t ƒëang giao ti·∫øp v·ªõi load balancer, ·ªü ph√≠a LB, ch√∫ng ta s·∫Ω c√≥ th√™m m·ªôt v√†i ch·ª©c nƒÉng kh√°c vi·ªác load balancing nh∆∞ NAT, ƒë√≥ l√† LB c√≥ th·ªÉ ch·ªçn gi·ªØ ho·∫∑c ghi ƒë√® ƒë·ªãa ch·ªâ IP c·ªßa client,...</p>
<p><strong>∆Øu ƒëi·ªÉm</strong></p>
<ul>
<li>D·ªÖ c√†i ƒë·∫∑t v√† s·ª≠ d·ª•ng</li>
<li>Kh√¥ng ph·ª• thu·ªôc v√†o ng√¥n ng·ªØ l·∫≠p tr√¨nh khi hi·ªán th·ª±c client/server</li>
<li>TƒÉng t√≠nh an to√†n cho server</li>
<li>C√≥ th·ªÉ scale b·∫±ng c√°ch th√™m nhi·ªÅu instance c·ªßa load balancer</li>
</ul>
<p><strong>Nh∆∞·ª£c ƒëi·ªÉm</strong></p>
<ul>
<li>N·∫øu kh√¥ng qu·∫£n l√Ω t·ªët, load balancer c√≥ th·ªÉ l√† ƒëi·ªÉm g√¢y l·ªói duy nh·∫•t (single point of failure)</li>
<li>TƒÉng latency c·ªßa request</li>
</ul>
<h2><a href="#v√≠-d·ª•" aria-hidden="true" class="anchor" id="v√≠-d·ª•"></a>V√≠ d·ª•</h2>
<p>M√¨nh s·∫Ω s·ª≠ d·ª•ng HAProxy ƒë·ªÉ l√†m v√≠ d·ª• cho ph∆∞∆°ng ph√°p n√†y. Th√¥ng tin nh∆∞ sau:</p>
<ul>
<li>3 gRPC server ch·∫°y ·ªü port 50051, 50052, 50053</li>
<li>HAProxy listen ·ªü port 8443</li>
<li>2 gRPC client th·ª±c hi·ªán request ƒë·∫øn HAProxy</li>
</ul>
<p><strong>C·∫•u h√¨nh c·ªßa HaProxy</strong></p>
<pre><code class="language-bash">global
  tune.ssl.default-dh-param 1024

defaults
  timeout connect 10000ms
  timeout client 60000ms
  timeout server 60000ms

frontend lb_grpc
  mode tcp
  bind *:8443 npn spdy/2 alpn h2
  default_backend be_grpc

# gRPC servers running on port 8083-8084
backend be_grpc
  mode tcp
  balance roundrobin
  option httpchk HEAD / HTTP/2
  server srv01 127.0.0.1:50051
  server srv02 127.0.0.1:50052
  server srv03 127.0.0.1:50053
</code></pre>
<p><strong>Server code</strong></p>
<pre><code class="language-go">type server struct {
	serverId string
	pb.UnimplementedDemoServiceServer
}

func (s *server) SayHello(ctx context.Context, req *pb.HelloRequest) (*pb.HelloResponse, error) {
	fmt.Printf(&quot;server %v receive message from lb\n&quot;, s.serverId)
	return &amp;pb.HelloResponse{Message: &quot;Hello &quot; + req.Name}, nil
}

func main() {
	go serve(&quot;50051&quot;)
	go serve(&quot;50052&quot;)
	go serve(&quot;50053&quot;)
	ctx, stop := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)
	defer stop()
	&lt;-ctx.Done()
}

func serve(port string) {
	lis, err := net.Listen(&quot;tcp&quot;, &quot;:&quot;+port)
	if err != nil {
		log.Fatalf(&quot;failed to listen: %v&quot;, err)
	}
	s := grpc.NewServer()
	pb.RegisterDemoServiceServer(s, &amp;server{serverId: port})

	fmt.Println(&quot;Server is running on port &quot; + port)
	if err := s.Serve(lis); err != nil {
		log.Fatalf(&quot;failed to serve: %v&quot;, err)
	}
}
</code></pre>
<p><strong>Client code</strong></p>
<pre><code class="language-go">func main() {
	for i := 0; i &lt; 3; i++ {
		go request()
	}
	ctx, stop := signal.NotifyContext(context.Background(), syscall.SIGINT, syscall.SIGTERM)
	defer stop()
	&lt;-ctx.Done()
}

func request() {
	conn, err := grpc.NewClient(&quot;localhost:8443&quot;, grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf(&quot;did not connect: %v&quot;, err)
	}
	defer func() {
		_ = conn.Close()
	}()

	c := pb.NewDemoServiceClient(conn)

	ctx, cancel := context.WithTimeout(context.Background(), 20*time.Second)
	defer cancel()

	_, err = c.SayHello(ctx, &amp;pb.HelloRequest{Name: &quot;world&quot;})
	if err != nil {
		log.Fatalf(&quot;could not greet: %v&quot;, err)
	}
}
</code></pre>
<p><strong>Service proto</strong></p>
<pre><code>syntax = &quot;proto3&quot;;

package dnt;

option go_package = &quot;/model&quot;;

service DemoService {
  rpc SayHello (HelloRequest) returns (HelloResponse);
}

message HelloRequest {
  string name = 1;
}

message HelloResponse {
  string message = 1;
}
</code></pre>
<p><strong>K·∫øt qu·∫£</strong></p>
<p>3 request ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi 3 server kh√°c nhau.</p>
<p><img src="img/grpc-server-lb.png" alt="grpc-server-lb" /></p>
<p>N·∫øu s·ª≠ d·ª•ng tool <code>netstat</code>, ch√∫ng ta c√≥ th·ªÉ th·∫•y c√°c tcp connection ƒë∆∞·ª£c t·∫°o ra t·ª´ client ƒë·∫øn HAProxy, t·ª´ HAProxy ƒë·∫øn gRPC server, c√≥ t·∫•t c·∫£ 6 connections ƒë∆∞·ª£c t·∫°o ra.</p>
<p><img src="img/grpc-netstat.png" alt="grpc-netstat" /></p>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/networking.html'>networking</a><a class='topic-tag' href='/tags/gRPC.html'>gRPC</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dangngoctam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>