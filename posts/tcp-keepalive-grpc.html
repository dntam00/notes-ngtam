<html>

<head>
  <title>gRPC connection keep alive | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script src="../js/toc.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container has-toc navigation-box">
            <p><a href="/">&larr; Quay v·ªÅ trang ch·ªß</a></p>
        </div>
  <div class="container has-toc">
    <div class="table-of-contents">
      <div class="toc-title">Table of Contents</div><ul class="toc-list">  <li><a href="#nlb-aws" class="toc-link toc-level-2"><span class="toc-hash">#</span> NLB AWS</a></li>
  <li><a href="#grpc-in-linux-os" class="toc-link toc-level-2"><span class="toc-hash">#</span> gRPC in Linux OS</a></li>
  <li><a href="#gii-php" class="toc-link toc-level-2"><span class="toc-hash">#</span> Gi·∫£i ph√°p</a></li>
    <li><a href="#server" class="toc-link toc-level-3"><span class="toc-hash">#</span> Server</a></li>
    <li><a href="#client" class="toc-link toc-level-3"><span class="toc-hash">#</span> Client</a></li>
  <li><a href="#kt-bi" class="toc-link toc-level-2"><span class="toc-hash">#</span> K·∫øt b√†i</a></li></ul>
    </div>
    <div class="main">
      <h1>gRPC connection keep alive</h1>
      <p>Hello ~,</p>
<p>Tu·∫ßn r·ªìi trong l√∫c anh QA th·ª±c hi·ªán performance test th√¨ ·∫£nh th·∫•y gRPC client c√≥ xu·∫•t hi·ªán nhi·ªÅu log error <code>connection reset by peer</code>:</p>
<pre><code class="language-text">Error call to _: rpc error:
code = Unavailable desc = error reading from server:
read tcp &lt;src&gt;-&gt;&lt;dest&gt;: read: connection reset by peer
</code></pre>
<p>M√¥ h√¨nh tri·ªÉn khai hi·ªán t·∫°i l√† gRPC server s·∫Ω n·∫±m sau m·ªôt NLB ƒë·ªÉ chia t·∫£i. Nh·ªØng l·ªói ki·ªÉu n√†y mu√¥n thu·ªü s·∫Ω li√™n quan ƒë·∫øn vi·ªác TCP connection b·ªã ƒë√≥ng (c√≥ th·ªÉ ƒë√∫ng ho·∫∑c kh√¥ng ƒë√∫ng c√°ch) v√† t·∫ßng ·ª©ng d·ª•ng kh√¥ng ph√°t hi·ªán k·ªãp th·ªùi n√™n v·∫´n s·ª≠ d·ª•ng c√°c connection n√†y ƒë·ªÉ g·ª≠i/nh·∫≠n d·ªØ li·ªáu.</p>
<p>ƒê·ªÉ x·ª≠ l√Ω nh·ªØng v·∫•n ƒë·ªÅ n√†y th√¨ ch·∫Øc h·∫≥n m·ªçi ng∆∞·ªùi ƒë·ªÅu nghƒ© ƒë·∫øn c∆° ch·∫ø <code>ping-pong</code> v√† <code>retry</code> r·ªìi, tuy nhi√™n v√¨ m√¨nh mu·ªën t√¨m hi·ªÉu c·ª• th·ªÉ v√¨ sao connection b·ªã ƒë√≥ng v·ªõi m√¥ h√¨nh hi·ªán t·∫°i, n√™n c√≥ b√†i vi·∫øt n√†y :V.</p>
<h2><a href="#nlb-aws" aria-hidden="true" class="anchor" id="nlb-aws"></a>NLB AWS</h2>
<p>T√†i li·ªáu ch√≠nh th·ª©c c·ªßa AWS c√≥ ƒë·ªÅ c·∫≠p t·ªõi c√°ch h·ªç hi·ªán th·ª±c <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/network-load-balancers.html#connection-idle-timeout">idle timeout</a> ·ªü NLB. Sau khi ƒë·ªçc v√† ch·∫°y th·ª≠ m·ªôt s·ªë tr∆∞·ªùng h·ª£p, m√¨nh c√≥ r√∫t ra v√†i √Ω sau ƒë√¢y:</p>
<ul>
<li>NLB ho·∫°t ƒë·ªông v·ªõi keep alive packet c·ªßa TCP connection, ƒëi·ªÅu n√†y kh√°c v·ªõi ALB.</li>
<li>Ng∆∞·ªùi d√πng kh√¥ng c·∫•u h√¨nh ƒë∆∞·ª£c th·ªùi gian <code>idle timeout</code>.</li>
</ul>
<p><strong>-&gt; c·∫≠p nh·∫≠t ng√†y 10/11/2024:</strong> AWS ƒë√£ b·ªï sung t√≠nh nƒÉng ƒëi·ªÅu ch·ªânh <code>idle timeout</code> tr√™n NLB.</p>
<blockquote>
<p>The default idle timeout value for TCP flows is 350 seconds, <strong>but can be updated to any value between 60-6000 seconds</strong>. Clients or targets can use TCP keepalive packets to restart the idle timeout. Keepalive packets sent to maintain TLS connections can't contain data or payload.</p>
</blockquote>
<ul>
<li>NLB gi·ªØ tr·∫°ng th√°i c·ªßa m·ªói connection, khi <code>idle timeout</code> qua ƒëi, NLB kh√¥ng ƒë√≥ng connection b·∫±ng c√°c g√≥i tin <code>FIN/RST</code> m√† ch·ªâ g·ª≠i nh·ªØng g√≥i tin n√†y khi client s·ª≠ d·ª•ng l·∫°i connection sau th·ªùi gian <code>idle timeout</code>.</li>
</ul>
<h2><a href="#grpc-in-linux-os" aria-hidden="true" class="anchor" id="grpc-in-linux-os"></a>gRPC in Linux OS</h2>
<p>M·ªùi b·∫°n tham kh·∫£o b√†i vi·∫øt c·ªßa <a href="https://blog.cloudflare.com/when-tcp-sockets-refuse-to-die">Cloudflare engineer</a> ƒë·ªÉ hi·ªÉu ƒë∆∞·ª£c chi ti·∫øt v·ªÅ c√°c y·∫øu t·ªë ·∫£nh h∆∞·ªüng ƒë·∫øn m·ªôt TCP connection.</p>
<ul>
<li>Th√¥ng s·ªë TCP keep alive</li>
</ul>
<pre><code class="language-python">    SO_KEEPALIVE  # enable
    TCP_KEEPIDLE  # idle timeout ƒë·ªÉ TCP stack b·∫Øt ƒë·∫ßu g·ª≠i g√≥i tin keepalive
    TCP_KEEPINTVL # kho·∫£ng c√°ch gi·ªØa 2 g√≥i tin keepalive
    TCP_KEEPCNT   # s·ªë g√≥i tin TCP keepalive t·ªëi ƒëa ƒë∆∞·ª£c g·ª≠i tr∆∞·ªõc khi connection b·ªã ƒë√≥ng
</code></pre>
<ul>
<li>TCP_USER_TIMEOUT: th·ªùi gian t·ªëi ƒëa ƒë·ªÉ nh·∫≠n g√≥i tin <code>ACK</code> c·ªßa m·ªôt g√≥i tin ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒëi</li>
</ul>
<p>Khi xem th√™m source code c·ªßa gRPC, m√¨nh th·∫•y h·ªç c√≥ c·∫•u h√¨nh timeout d√†nh cho server:</p>
<pre><code class="language-go">// After having pinged for keepalive check, the server waits for a duration
// of Timeout and if no activity is seen even after that the connection is
// closed.
Timeout time.Duration // The current default value is 20 seconds.
</code></pre>
<p>gi√° tr·ªã n√†y c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† 20 gi√¢y ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ g√°n cho <code>TCP_USER_TIMEOUT</code> khi t·∫°o transport layer:</p>
<pre><code>if kp.Time != infinity {
    if err = syscall.SetTCPUserTimeout(rawConn, kp.Timeout); err != nil {
        return nil, connectionErrorf(false, err, &quot;transport: failed to set TCP_USER_TIMEOUT: %v&quot;, err)
    }
}
</code></pre>
<p>ƒê·ªëi v·ªõi c√°c th√¥ng s·ªë TCP keep alive, gRPC s·ª≠ d·ª•ng th∆∞ vi·ªán <code>net/http</code> c·ªßa Go ƒë·ªÉ t·∫°o connection</p>
<pre><code class="language-go">func newTCPConn(fd *netFD, keepAlive time.Duration, keepAliveHook func(time.Duration)) *TCPConn {
	setNoDelay(fd, true)
	if keepAlive == 0 {
		keepAlive = defaultTCPKeepAlive // 15 seconds
	}
	if keepAlive &gt; 0 {
		setKeepAlive(fd, true)
		setKeepAlivePeriod(fd, keepAlive)
		if keepAliveHook != nil {
			keepAliveHook(keepAlive)
		}
	}
	return &amp;TCPConn{conn{fd}}
}

// h√†m n√†y g√°n c·∫£ 2 th√¥ng s·ªë TCP_KEEPIDLE v√† TCP_KEEPINTVL v·ªõi c√πng 1 gi√° tr·ªã, m·∫∑c ƒë·ªãnh l√† 15 gi√¢y.
func setKeepAlivePeriod(fd *netFD, d time.Duration) error {
	// The kernel expects seconds so round to next highest second.
	secs := int(roundDurationUp(d, time.Second))
	if err := fd.pfd.SetsockoptInt(syscall.IPPROTO_TCP, syscall.TCP_KEEPINTVL, secs); err != nil {
		return wrapSyscallError(&quot;setsockopt&quot;, err)
	}
	err := fd.pfd.SetsockoptInt(syscall.IPPROTO_TCP, syscall.TCP_KEEPIDLE, secs)
	runtime.KeepAlive(fd)
	return wrapSyscallError(&quot;setsockopt&quot;, err)
}
</code></pre>
<p>Nh∆∞ v·∫≠y, v·ªõi gi√° tr·ªã c·ªßa nh·ªØng th√¥ng s·ªë m·∫∑c ƒë·ªãnh n√†y, n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu truy·ªÅn qua 1 connection trong v√≤ng 15 gi√¢y, TCP s·∫Ω b·∫Øt ƒë·∫ßu g·ª≠i keepalive v√† ch·ªâ c·∫ßn 2 g√≥i tin keepalive kh√¥ng nh·∫≠n v·ªÅ g√≥i tin <code>ACK</code> th√¨ TCP s·∫Ω ƒë√≥ng connection v√† g·ª≠i g√≥i tin <code>RST</code> ƒë·∫øn NLB. ƒê·ªëi v·ªõi tr∆∞·ªùng h·ª£p c√≥ 1 s·ªë l∆∞·ª£ng l·ªõn connection th√¨ hi·ªán t∆∞·ª£ng n√†y c≈©ng c√≥ th·ªÉ x·∫£y ra th∆∞·ªùng xuy√™n.</p>
<h2><a href="#gi·∫£i-ph√°p" aria-hidden="true" class="anchor" id="gi·∫£i-ph√°p"></a>Gi·∫£i ph√°p</h2>
<p>gRPC cung c·∫•p c∆° ch·∫ø ch·ªß ƒë·ªông <code>ping-pong</code>, t·∫ßng ·ª©ng d·ª•ng n√™n s·ª≠ d·ª•ng c√°c c∆° ch·∫ø ch·ªß ƒë·ªông n√†y thay v√¨ ph·ª• thu·ªôc ho√†n to√†n v√†o c√°c t·∫ßng th·∫•p h∆°n.</p>
<h3><a href="#server" aria-hidden="true" class="anchor" id="server"></a>Server</h3>
<pre><code class="language-go">type ServerParameters struct {

    // After a duration of this time if the server doesn't see any activity it
    // pings the client to see if the transport is still alive.
    // If set below 1s, a minimum value of 1s will be used instead.
    Time time.Duration // The current default value is 2 hours.


    // After having pinged for keepalive check, the server waits for a duration
    // of Timeout and if no activity is seen even after that the connection is
    // closed.
    Timeout time.Duration // The current default value is 20 seconds.
}

// example
var kasp = keepalive.ServerParameters{
    //MaxConnectionIdle:     15 * time.Second, // If a client is idle for 15 seconds, send a GOAWAY
    //MaxConnectionAge:      30 * time.Second, // If any connection is alive for more than 30 seconds, send a GOAWAY
    //MaxConnectionAgeGrace: 5 * time.Second,  // Allow 5 seconds for pending RPCs to complete before forcibly closing connections
    Time:    10 * time.Second, // Ping the client if it is idle for 10 seconds to ensure the connection is still active
    Timeout: 20 * time.Second, // Wait 1 second for the ping ack before assuming the connection is dead
}
</code></pre>
<p>M√¨nh ƒë√£ ch·∫°y gRPC v·ªõi c·∫•u h√¨nh v√≠ d·ª• ·ªü tr√™n, s·ª≠ d·ª•ng client ƒë·ªÉ t·∫°o 1 connection t·ªõi server v√† theo d√µi qua wireshark, k·∫øt qu·∫£ sau 10 gi√¢y th√¨ server s·∫Ω g·ª≠i 1 g√≥i tin <code>ping frame</code> ƒë·∫øn client.</p>
<p><img src="img/grpc-ping-frame.png" alt="grpc-ping-frame" /></p>
<p><code>Ping frame</code> c√≥ ƒë·ªô d√†i 17 bytes v·ªõi c·∫•u tr√∫c nh∆∞ h√¨nh d∆∞·ªõi v·ªõi c√°c ƒë∆°n v·ªã trong ngo·∫∑c l√† bit:</p>
<pre><code>+--------------------------------------------------------------------+
| Length (24) | Type (8) | Flags (8) | Reserved (1) | Stream ID (31) |
+--------------------------------------------------------------------+
| Opaque Data (64)                                                   |
+--------------------------------------------------------------------+
</code></pre>
<p>t∆∞∆°ng ·ª©ng v·ªõi ƒëo·∫°n code sau trong th∆∞ vi·ªán:</p>
<pre><code class="language-go">func (f *Framer) WritePing(ack bool, data [8]byte) error {
	var flags Flags
	if ack {
		flags = FlagPingAck
	}
	f.startWrite(FramePing, flags, 0)
	f.writeBytes(data[:])
	return f.endWrite()
}
</code></pre>
<h3><a href="#client" aria-hidden="true" class="anchor" id="client"></a>Client</h3>
<pre><code class="language-go">kaConfig := grpcConfig.GrpcKeepAlive
		
ka := grpc.WithKeepaliveParams(keepalive.ClientParameters{
	Time:                time.Duration(kaConfig.PingInterval) * time.Second,
	Timeout:             time.Duration(kaConfig.PingTimeout) * time.Second,
	PermitWithoutStream: kaConfig.PermitWithoutStream,
})
</code></pre>
<p>·ªû ph√≠a client, nh·ªØng th√¥ng s·ªë n√†y c·∫ßn ƒë∆∞·ª£c suy nghƒ© c·∫©n th·∫≠n v√† ph√π h·ª£p v·ªõi ph√≠a server, gi√° tr·ªã c√†ng nh·ªè th√¨ client s·∫Ω √≠t g·∫∑p l·ªói h∆°n, tuy nhi√™n vi·ªác g·ª≠i ping qu√° nhi·ªÅu v√† li√™n t·ª•c c≈©ng g√¢y ·∫£nh h∆∞·ªüng ƒë·∫øn server.</p>
<h2><a href="#k·∫øt-b√†i" aria-hidden="true" class="anchor" id="k·∫øt-b√†i"></a>K·∫øt b√†i</h2>
<p>Trong b√†i n√†y m√¨nh ƒë√£ t√≥m t·∫Øt l·∫°i nh·ªØng y·∫øu t·ªë ·∫£nh h∆∞·ªüng ƒë·∫øn tr·∫°ng th√°i c·ªßa m·ªôt TCP connection c≈©ng nh∆∞ c√°ch th∆∞ vi·ªán gRPC c·ªßa Go s·ª≠ d·ª•ng ƒë·ªÉ hi·ªán th·ª±c protocol, c√≥ m·ªôt v√†i t·ª´ kho√° ƒë·ªÉ b·∫°n c√≥ th·ªÉ nghi√™n c·ª©u s√¢u th√™m:</p>
<ul>
<li>TCP keepalive</li>
<li>TCP user time out</li>
<li>gRPC ping frame</li>
</ul>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/tcp.html'>tcp</a><a class='topic-tag' href='/tags/networking.html'>networking</a><a class='topic-tag' href='/tags/grpc.html'>grpc</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>