<html>

<head>
  <title>Async annotation in Spring | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container">
    <div class="main">
      <p><a href="/">&lt;- Quay v·ªÅ trang ch·ªß</a></p>
      <h1>Async annotation in Spring</h1>
      <p>Spring - framework toi yeu. :&quot;)</p>
<p>Khi s·ª≠ d·ª•ng Spring ƒë·ªÉ ph√°t tri·ªÉn c√°c ·ª©ng d·ª•ng web, annotation l√† m·ªôt ph·∫ßn kh√¥ng th·ªÉ thi·∫øu,
t·ª´ thu·ªü b·∫Øt ƒë·∫ßu, Spring s·ª≠ d·ª•ng xml ƒë·ªÉ c·∫•u h√¨nh m·ªçi th·ª©, nh∆∞ng r√µ r√†ng c√°ch n√†y r·∫•t c·ªìng k·ªÅnh v√† m·∫•t th·ªùi gian,
th·ªùi gian tr√¥i qua, m·ªçi th·ª© ƒë·ªÅu ph√°t tri·ªÉn, Spring c≈©ng v·∫≠y, thay v√¨ s·ª≠ d·ª•ng xml,
b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c annotation ƒë·ªÉ c·∫•u h√¨nh,
l·∫≠p tr√¨nh v·ªõi ch∆∞∆°ng tr√¨nh c·ªßa m√¨nh.
Tuy nhi√™n, c√≥ bao gi·ªù b·∫°n th·∫Øc m·∫Øc ƒëi·ªÅu g√¨ x·∫£y ra b√™n d∆∞·ªõi nh·ªØng c√°i annotation ƒë√≥?
Sau khi s·ª≠ d·ª•ng framework 1 th·ªùi gian, m√¨nh c≈©ng c·ªë g·∫Øng t√¨m hi·ªÉu nh·ªØng th·ª© ƒë√≥,
v√† n√≥ d·∫´n t·ªõi b√†i n√†y (v√† 1 v√†i b√†i ti·∫øp theo?). ƒê·ªÉ hi·ªÉu ƒë∆∞·ª£c nguy√™n l√≠ ƒë·∫±ng sau nh·ªØng annotation,
b·∫°n c·∫ßn t√¨m hi·ªÉu v·ªÅ c√°c ph·∫ßn sau:</p>
<ul>
<li>Bean life cycle</li>
<li>Spring AOP</li>
<li>Dynamic proxy</li>
</ul>
<p>‚Äî-----</p>
<p>Trong b√†i n√†y, m√¨nh s·∫Ω vi·∫øt v·ªÅ annotation <code>Async</code>.</p>
<p>Annotation n√†y cho ph√©p b·∫°n th·ª±c hi·ªán l·ªùi g·ªçi h√†m b·∫•t ƒë·ªìng b·ªô,
h√†m ƒë∆∞·ª£c g·ªçi s·∫Ω ƒë∆∞·ª£c th·ª±c thi trong m·ªôt thread kh√°c v√† h√†m g·ªçi kh√¥ng c·∫ßn ch·ªù h√†m ƒë∆∞·ª£c g·ªçi th·ª±c thi xong ƒë·ªÉ ti·∫øp t·ª•c hay k·∫øt th√∫c,
ƒëi·ªÅu n√†y gi√∫p b·∫°n t·ªëi ∆∞u performance khi c√≥ nh·ªØng c√¥ng vi·ªác t·ªën th·ªùi gian m√† kh√¥ng c·∫ßn th·ª±c thi theo th·ª© t·ª±,
m·ªôt tr∆∞·ªùng h·ª£p th∆∞·ªùng g·∫∑p ƒë√≥ l√† vi·ªác g·ª≠i th√¥ng b√°o cho ng∆∞·ªùi d√πng.</p>
<p>ƒê·ªÉ d√πng annotation n√†y, b·∫°n ch·ªâ c·∫ßn s·ª≠ d·ª•ng:</p>
<ul>
<li><code>@EnableAsync</code></li>
<li><code>@Async</code></li>
<li>Thread pool executor</li>
</ul>
<pre><code class="language-java">@Service
@Slf4j
@EnableAsync
public class ExecutorService {

    @Async(&quot;asyncExecutor&quot;)
    public void sample() {
        log.info(&quot;hello :))&quot;);
    }
}

@Configuration
@Slf4j
@RequiredArgsConstructor
public class ExecutorThreadPool {

    private final ThreadPoolProperties properties;

    @Bean(name = &quot;asyncExecutor&quot;)
    public Executor asyncExecutor() throws InterruptedException {
        ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();

        taskExecutor.setCorePoolSize(properties.getCoreSize());
        taskExecutor.setMaxPoolSize(properties.getMaxSize());
        taskExecutor.setQueueCapacity(properties.getQueueSize());
        taskExecutor.setThreadNamePrefix(properties.getPrefixName());
        taskExecutor.setPrestartAllCoreThreads(properties.isPreStart());
        taskExecutor.setRejectedExecutionHandler(properties.getPolicy().getHandler());
        taskExecutor.setBeanName(&quot;asyncExecutor&quot;);
        taskExecutor.initialize();
        log.info(&quot;Initialize ThreadPoolTaskExecutor: {}&quot;, properties);
        printStats(taskExecutor);

        return taskExecutor;
    }
}
</code></pre>
<p>V·ªÅ l√≠ thuy·∫øt, b·∫°n c√≥ th·ªÉ kh√¥ng c·∫ßn s·ª≠ d·ª•ng thread pool executor v√¨ Spring s·∫Ω t·ª± ƒë·ªông qu·∫£n l√Ω,
nh∆∞ng trong th·ª±c t·∫ø, ch√∫ng ta n√™n c·∫•u h√¨nh m·ªôt thread pool tu·ª≥ thu·ªôc v√†o nhu c·∫ßu v√† c·∫•u h√¨nh c·ªßa server,
vi·ªác n√†y s·∫Ω mang l·∫°i nhi·ªÅu l·ª£i √≠ch:</p>
<ul>
<li>qu·∫£n l√Ω ƒë∆∞·ª£c t√†i nguy√™n ƒë∆∞·ª£c s·ª≠ d·ª•ng</li>
<li>ch·ªâ ƒë·ªãnh prefix t√™n thread, d·ªÖ d√†ng trace log</li>
<li>ch·ªâ ƒë·ªãnh ƒë∆∞·ª£c queue size</li>
<li>ch·ªâ ƒë·ªãnh c√°ch executor x·ª≠ l√Ω khi s·ªë job v∆∞·ª£t qu√° nh·ªØng th√¥ng s·ªë ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh</li>
</ul>
<p>Ti·∫øp theo, l√†m th·∫ø n√†o Spring x·ª≠ l√Ω ƒë∆∞·ª£c annotation <code>@Async</code>?
C√¢u tr·∫£ l·ªùi n·∫±m ·ªü dynamic proxy.</p>
<p><img src="img/proxy-async.png" alt="Proxy async object" /></p>
<p>Flow ho·∫°t ƒë·ªông:</p>
<ul>
<li><code>object caller</code> gi·ªØ kh√¥ng ph·∫£i l√† <code>target object</code> m√† l√† <code>proxy object</code>,
ƒëi·ªÅu n√†y ƒë∆∞·ª£c hi·ªán th·ª±c khi Spring kh·ªüi t·∫°o ch∆∞∆°ng tr√¨nh</li>
<li><code>proxy object</code> c√≥ h√†m <code>method</code> gi·ªëng v·ªõi <code>target object</code>,
trong h√†m n√†y n√≥ hi·ªán th·ª±c th√™m logic submit task v√†o queue,
task n√†y s·∫Ω ch·ª©a logic g·ªçi h√†m <code>method</code> c·ªßa <code>target object</code></li>
<li><code>executor</code> s·∫Ω ch·ªãu tr√°ch nhi·ªám l·∫•y task t·ª´ queue v√† th·ª±c thi</li>
</ul>
<p>V·∫´n ch∆∞a r√µ r√†ng l·∫Øm, v·∫≠y <code>proxy object</code> ·ªü ƒë√¢u ra m√† n√≥ ƒë∆∞·ª£c inject v√†o <code>caller object</code>?</p>
<p>C√¢u tr·∫£ l·ªùi n·∫±m ·ªü l√∫c Spring kh·ªüi t·∫°o bean,
Spring chia qu√° tr√¨nh kh·ªüi t·∫°o ra nhi·ªÅu giai ƒëo·∫°n:</p>
<ul>
<li>Instantiation</li>
<li>Populating Properties</li>
<li>Pre-Initialization</li>
<li>AfterPropertiesSet</li>
<li>Custom Initialization</li>
<li><font color="red">Post-Initialization</font></li>
</ul>
<p>·ªû giai ƒëo·∫°n <code>Post-Initialization</code>, Spring s·∫Ω x√°c ƒë·ªãnh bean c√≥ c·∫ßn ƒë∆∞·ª£c b·ªçc l·∫°i
b·ªüi object proxy hay kh√¥ng? ƒê√¢y l√† ƒëo·∫°n code:</p>
<pre><code class="language-java">AbstractAdvisingBeanPostProcessor#postProcessAfterInitialization

public Object postProcessAfterInitialization(Object bean, String beanName) {
    if (this.advisor == null || bean instanceof AopInfrastructureBean) {
        // Ignore AOP infrastructure such as scoped proxies.
        return bean;
    }

    if (bean instanceof Advised advised) {
        if (!advised.isFrozen() &amp;&amp; isEligible(AopUtils.getTargetClass(bean))) {
            // Add our local Advisor to the existing proxy's Advisor chain.
            if (this.beforeExistingAdvisors) {
                    advised.addAdvisor(0, this.advisor);
            }
            
            // omitted for briefly....
            
            return bean;
        }
    }

    if (isEligible(bean, beanName)) {
        ProxyFactory proxyFactory = prepareProxyFactory(bean, beanName);
        proxyFactory.addAdvisor(this.advisor);
        customizeProxyFactory(proxyFactory);
        
        // omitted for briefly....
        
        return proxyFactory.getProxy(classLoader);
    }

    // No proxy needed.
    return bean;
}
</code></pre>
<p>Trong tr∆∞·ªùng h·ª£p object proxy ƒë∆∞·ª£c t·∫°o, ch√∫ √Ω c√°ch m√† Spring kh·ªüi t·∫°o proxy factory,
framework th√™m <code>advisor</code> v√†o <code>proxy factory</code> tr∆∞·ªõc khi t·∫°o ra object proxy
b·∫±ng c√¢u l·ªánh <code>proxyFactory.getProxy(classLoader)</code>.</p>
<p><code>Advisor</code> trong tr∆∞·ªùng h·ª£p c·ªßa <code>@Async</code> annotation l√† <code>AsyncAnnotationAdvisor</code>,
d∆∞·ªõi ƒë√¢y l√† ƒëo·∫°n code kh·ªüi t·∫°o <code>advisor</code>:</p>
<pre><code class="language-java">public AsyncAnnotationAdvisor(@Nullable Supplier&lt;Executor&gt; executor, 
            @Nullable Supplier&lt;AsyncUncaughtExceptionHandler&gt; exceptionHandler) {

    Set&lt;Class&lt;? extends Annotation&gt;&gt; asyncAnnotationTypes = new LinkedHashSet&lt;&gt;(2);
    asyncAnnotationTypes.add(Async.class);

    ClassLoader classLoader = AsyncAnnotationAdvisor.class.getClassLoader();
    try {
        asyncAnnotationTypes.add((Class&lt;? extends Annotation&gt;)
                ClassUtils.forName(&quot;jakarta.ejb.Asynchronous&quot;, classLoader));
    }
    catch (ClassNotFoundException ex) {
        // If EJB API not present, simply ignore.
    }
    try {
        asyncAnnotationTypes.add((Class&lt;? extends Annotation&gt;)
                ClassUtils.forName(&quot;jakarta.enterprise.concurrent.Asynchronous&quot;, classLoader));
    }
    catch (ClassNotFoundException ex) {
        // If Jakarta Concurrent API not present, simply ignore.
    }

    this.advice = buildAdvice(executor, exceptionHandler);
    this.pointcut = buildPointcut(asyncAnnotationTypes);
}

protected Advice buildAdvice(@Nullable Supplier&lt;Executor&gt; executor, 
                             @Nullable Supplier&lt;AsyncUncaughtExceptionHandler&gt; exceptionHandler) {

    AnnotationAsyncExecutionInterceptor interceptor = new AnnotationAsyncExecutionInterceptor(null);
    interceptor.configure(executor, exceptionHandler);
    return interceptor;
}
</code></pre>
<p><code>Advice</code> ƒë∆∞·ª£c s·ª≠ d·ª•ng l√† <code>AnnotationAsyncExecutionInterceptor</code>, v·∫≠y ƒë·∫øn ƒë√¢y,
b·∫°n c√≥ th·ªÉ ƒëo√°n r·∫±ng khi g·ªçi h√†m ƒë∆∞·ª£c ƒë√°nh annotation <code>@Async</code> c·ªßa <code>target object</code>,
m·ªôt h√†m trong class <code>AnnotationAsyncExecutionInterceptor</code> ho·∫∑c
parent class c·ªßa n√≥ s·∫Ω ƒë∆∞·ª£c g·ªçi. ƒê·ªÉ x√°c th·ª±c, m√¨nh d√πng Intellij ƒë·ªÉ debug:</p>
<p><img src="img/interceptor.png" alt="Interceptor" /></p>
<p>khi m√¨nh g·ªçi h√†m sample, c√°c b·∫°n th·∫•y n√≥ n·∫±m trong object proxy <code>$$SpringCGLIB$$0</code>,
v√† cu·ªëi c√πng ƒë·∫øn h√†m invoke  c·ªßa class <code>AsyncExecutionInterceptor</code>,
class n√†y l√† parent c·ªßa class <code>AnnotationAsyncExecutionInterceptor</code>
nh∆∞ m√¨nh ƒë·ªÅ c·∫≠p ·ªü tr√™n.</p>
<pre><code class="language-java">public Object invoke(final MethodInvocation invocation) throws Throwable {
    Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);
    Method specificMethod = ClassUtils.getMostSpecificMethod(invocation.getMethod(), targetClass);
    final Method userDeclaredMethod = BridgeMethodResolver.findBridgedMethod(specificMethod);

    AsyncTaskExecutor executor = determineAsyncExecutor(userDeclaredMethod);
    if (executor == null) {
        throw new IllegalStateException(
                &quot;No executor specified and no default executor set on AsyncExecutionInterceptor either&quot;);
    }

    Callable&lt;Object&gt; task = () -&gt; {
        try {
            Object result = invocation.proceed();
            if (result instanceof Future&lt;?&gt; future) {
                return future.get();
            }
        }
        catch (ExecutionException ex) {
            handleError(ex.getCause(), userDeclaredMethod, invocation.getArguments());
        }
        catch (Throwable ex) {
            handleError(ex, userDeclaredMethod, invocation.getArguments());
        }
        return null;
    };

    return doSubmit(task, executor, invocation.getMethod().getReturnType());
}
</code></pre>
<p>·ªü h√†m <code>invoke</code>, Spring wrap ƒëo·∫°n code g·ªçi h√†m <code>invocation.proceed()</code> l·∫°i
v√† submit v√†o executor ƒë·ªÉ n√≥ th·ª±c thi b·∫•t ƒë·ªìng b·ªô, l∆∞u √Ω <code>invocation.proceed()</code>
c√≥ th·ªÉ l√† target method,
ho·∫∑c m·ªôt method <code>invoke</code> kh√°c trong chain b·ªüi v√¨ ch√∫ng ta c√≥ th·ªÉ √°p d·ª•ng
nhi·ªÅu aspect cho c√πng m·ªôt method.</p>
<p>Cu·ªëi c√πng, m√¨nh ch·∫°y ch∆∞∆°ng tr√¨nh v√† monitor thread pool executor ƒë·ªÉ xem th·ªëng k√™:</p>
<pre><code class="language-bash">2024-04-30T14:14:23.958+07:00  INFO [,,] 60157 --- [pool-1-thread-1] n.l.asycnannotation.ExecutorThreadPool   : Pool Size: 2
2024-04-30T14:14:23.961+07:00  INFO [,,] 60157 --- [pool-1-thread-1] n.l.asycnannotation.ExecutorThreadPool   : Active Threads: 0
2024-04-30T14:14:23.961+07:00  INFO [,,] 60157 --- [pool-1-thread-1] n.l.asycnannotation.ExecutorThreadPool   : Number of Tasks Completed: 24
2024-04-30T14:14:23.961+07:00  INFO [,,] 60157 --- [pool-1-thread-1] n.l.asycnannotation.ExecutorThreadPool   : Number of Tasks in Queue: 0
</code></pre>
<p>Qua b√†i vi·∫øt n√†y m√¨nh ƒë√£ ph√¢n t√≠ch c√°ch Spring kh·ªüi t·∫°o c≈©ng nh∆∞ hi·ªán th·ª±c annotation <code>@Async</code>,
ƒë·ªÉ c√≥ th·ªÉ hi·ªÉu r√µ v√† ·ª©ng d·ª•ng t∆∞∆°ng t·ª± v√†o c√°c annotation kh√°c c·ªßa Spring,
b·∫°n c√≥ th·ªÉ s·∫Ω ph·∫£i nghi√™n c·ª©u kƒ© h∆°n c√°c ph·∫ßn m√¨nh ƒë·ªÅ c·∫≠p ·ªü ƒë·∫ßu b√†i vi·∫øt.</p>
<p>B·∫°n c√≥ th·ªÉ tham kh·∫£o source code ·ªü ƒë√¢y: <a href="https://github.com/dntam00/learning-spring/tree/master/asycn-annotation">https://github.com/dntam00/learning-spring/tree/master/asycn-annotation</a></p>
<p>C·∫£m ∆°n b·∫°n ƒë√£ ƒë·ªçc ƒë·∫øn ƒë√¢y, h·∫πn g·∫∑p l·∫°i v√†o b√†i vi·∫øt ti·∫øp theo.</p>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/spring.html'>spring</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>