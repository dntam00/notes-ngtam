<html>

<head>
  <title>gRPC Load balancing | Tam's Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Tam's Blog</span></a>
  </div>
  <div class="container">
    <div class="main">
      <p><a href="/">&lt;- Quay vá» trang chá»§</a></p>
      <h1>gRPC Load balancing</h1>
      <p>Khi thá»‹ trÆ°á»ng cÃ³ xu hÆ°á»›ng chuyá»ƒn dáº§n tá»« monolithic sang microservice, bÃ i toÃ¡n giao tiáº¿p giá»¯a cÃ¡c service trá»Ÿ nÃªn ráº¥t quan trá»ng, vá»›i nhá»¯ng service thÃ´ng thÆ°á»ng hiá»‡n nay, mÃ¬nh tháº¥y cÃ³ 3 cÃ¡ch giao tiáº¿p chÃ­nh:</p>
<ul>
<li>HTTP APIs</li>
<li>gRPC</li>
<li>Message queue</li>
</ul>
<p>Khi triá»ƒn khai há»‡ thá»‘ng cáº§n xá»­ lÃ½ má»™t lÆ°á»£ng táº£i lá»›n, má»—i loáº¡i service sáº½ cáº§n pháº£i cháº¡y ráº¥t nhiá»u instance, váº­y bÃ i toÃ¡n Ä‘áº·t ra lÃ m tháº¿ nÃ o Ä‘á»ƒ chia táº£i giá»¯a cÃ¡c instance? Äá»™ hiá»‡u quáº£ cÅ©ng nhÆ° chi phÃ­ cÃ i Ä‘áº·t, báº£o trÃ¬ nhÆ° tháº¿ nÃ o? PhÆ°Æ¡ng phÃ¡p Ã¡p dá»¥ng cho má»—i protocol cÃ³ khÃ¡c nhau khÃ´ng?</p>
<p>Äá»ƒ tráº£ lá»i nhá»¯ng cÃ¢u há»i trÃªn, mÃ¬nh sáº½ viáº¿t má»™t chuá»—i bÃ i tÃ¬m hiá»ƒu vá» cÃ¡c phÆ°Æ¡ng phÃ¡p load balacing cho gRPC protocol.</p>
<h2><a href="#phÆ°Æ¡ng-phÃ¡p" aria-hidden="true" class="anchor" id="phÆ°Æ¡ng-phÃ¡p"></a>PhÆ°Æ¡ng phÃ¡p</h2>
<p>Hiá»‡n táº¡i cÃ³ má»™t vÃ i phÆ°Æ¡ng phÃ¡p phá»• biáº¿n Ä‘á»ƒ xá»­ lÃ½ grPC load balancing:</p>
<ul>
<li><strong>Proxy load balancing</strong>: lÃ  phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng, LB sáº½ Ä‘Ã³ng vai trÃ² nhÆ° má»™t reverse proxy, HAProxy, Nginx, LB cá»§a cloud provider,... lÃ  cÃ¡c vÃ­ dá»¥.</li>
<li><strong>Client side load balancing</strong>: phÃ­a client chá»§ Ä‘á»™ng quáº£n lÃ½ connection cÅ©ng nhÆ° cÆ¡ cháº¿ load balancing, cÃ³ thá»ƒ tá»± custom hoÃ n toÃ n dá»±a trÃªn cÃ¡c specification cá»§a gRPC hoáº·c káº¿t há»£p vá»›i ZooKeeper/Etcd/Consul,...</li>
<li><strong>Look-aside load balancing</strong>: cÃ³ má»™t external load balancing component chá»‹u trÃ¡ch nhiá»‡m quáº£n lÃ½ cÃ¡c servers (service discovery) vÃ  tráº£ lá»i thÃ´ng tin cho client má»—i khi Ä‘Æ°á»£c yÃªu cáº§u.</li>
<li><strong>Service mesh</strong>: sá»­ dá»¥ng cÃ¡c load balancer cÃ³ sáºµn trong cÃ¡c proxy nhÆ° Istio, Envoy,...</li>
</ul>
<p>Má»—i phÆ°Æ¡ng phÃ¡p sáº½ cÃ³ Æ°u nhÆ°á»£c Ä‘iá»ƒm riÃªng cÅ©ng nhÆ° chi phÃ­ cÃ i Ä‘áº·t, báº£o trÃ¬ khÃ¡c nhau.</p>
<h2><a href="#grpc-load-balancing" aria-hidden="true" class="anchor" id="grpc-load-balancing"></a>gRPC load balancing</h2>
<p>TrÆ°á»›c tiÃªn, hÃ£y cÃ¹ng mÃ¬nh phÃ¢n tÃ­ch má»™t vÃ i lÆ°u Ã½ vá» gRPC load balancing. CÃ³ pháº£i chá»‰ cáº§n sá»­ dá»¥ng load balancer trÆ°á»›c cá»¥m backend servers thÃ¬ má»i chuyá»‡n Ä‘Æ°á»£c giáº£i quyáº¿t?</p>
<p>gRPC lÃ  giao thá»©c sá»­ dá»¥ng <code>HTTP/2</code>, cÃ³ cÆ¡ cháº¿ multiplex nhiá»u request/response dá»±a trÃªn cÃ¹ng 1 connection, vÃ¬ tÃ­nh cháº¥t nÃ y, tcp connection Ä‘Æ°á»£c sá»­ dá»¥ng bá»Ÿi grpc sáº½ cÃ³ tÃ­nh cháº¥t <code>long-lived</code>, khÃ¡c vá»›i HTTP APIs dá»±a trÃªn <code>HTTP/1.1</code>.</p>
<p>Äá»ƒ phÃ¢n tÃ­ch, chÃºng ta sáº½ láº¥y trÆ°á»ng há»£p client khá»Ÿi táº¡o 1 connection Ä‘áº¿n LB vÃ  sá»­ dá»¥ng nÃ³ Ä‘á»ƒ gá»­i táº¥t cáº£ requests, viá»‡c tiáº¿p theo LB sáº½ cÃ¢n báº±ng táº£i nhá»¯ng requests nÃ y, tuy nhiÃªn sáº½ cÃ³ sá»± khÃ¡c nhau ráº¥t lá»›n khi LB hoáº¡t Ä‘á»™ng á»Ÿ L4 vÃ  L7.</p>
<h3><a href="#layer-4" aria-hidden="true" class="anchor" id="layer-4"></a>Layer 4</h3>
<p>CÃ¢n báº±ng táº£i á»Ÿ <code>layer 4</code>, LB sáº½ lÃ m viá»‡c á»Ÿ táº§ng á»©ng dá»¥ng vá»›i cÃ¡c gÃ³i tin TCP, má»™t khi client khá»Ÿi táº¡o 1 TCP connection tá»›i LB, nÃ³ sáº½ táº¡o 1 connection tÆ°Æ¡ng á»©ng Ä‘áº¿n má»™t backend server rá»“i chuyá»ƒn tiáº¿p táº¥t cáº£ gÃ³i tin dá»±a trÃªn sá»± Ã¡nh xáº¡ nÃ y.</p>
<p><img src="img/grpc-connection-load-balancing.png" alt="grpc-connection-load-balancing" /></p>
<p>Do tÃ­nh cháº¥t nÃ y, LB sáº½ cÃ¢n báº±ng táº£i cho quÃ¡ trÃ¬nh thiáº¿t láº­p connection, má»™t khi connection Ä‘Ã£ Ä‘Æ°á»£c táº¡o, táº¥t cáº£ request sáº½ Ä‘Æ°á»£c gá»­i trÃªn Ä‘Ã³, mÃ¬nh gá»i nÃ³ lÃ  <code>connection-based load balancing</code>. á» vÃ­ dá»¥ nhÆ° hÃ¬nh trÃªn, náº¿u client chá»‰ táº¡o 1 connection thÃ¬ sáº½ gÃ¢y ra hiá»‡n tÆ°á»£ng <code>server instance 2</code> hoáº·c <code>server instance 3</code> á»Ÿ tráº¡ng thÃ¡i <code>&quot;thÆ° giÃ£n&quot;</code>.</p>
<!-- Tuy nhiÃªn, váº¥n Ä‘á» xuáº¥t hiá»‡n vÃ¬ tÃ­nh cháº¥t `long-lived` nÃ y, khi LB táº¡o connection tá»›i má»™t backend server, táº¥t cáº£ nhá»¯ng requests sau Ä‘Ã³ sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n `server instance 1`, 2 servers cÃ²n láº¡i sáº½ ngá»“i chÆ¡i. Khi táº¡o má»›i má»™t connection khÃ¡c, tuá»³ vÃ o thuáº­t toÃ¡n `load balancing` á»Ÿ LB, connection má»›i cÃ³ thá»ƒ sáº½ tá»›i `server instance 2` hoáº·c `server instance 3`. Váº­y báº¡n cÃ³ thá»ƒ tháº¥y, dÃ¹ cho LB load balance á»Ÿ `layer 4` hay `layer 7` thÃ¬ kiá»ƒu load balancing nÃ y lÃ  `connection-based load balancing`. -->
<p>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, chÃºng ta sáº½ sá»­ dá»¥ng kÄ© thuáº­t <code>pooling</code> á»Ÿ phÃ­a client, má»¥c Ä‘Ã­ch lÃ  táº¡o nhiá»u connections thÃ´ng qua LB vÃ  sá»­ dá»¥ng chÃºng Ä‘á»ƒ gá»­i request. Khi pool Ä‘Æ°á»£c táº¡o:</p>
<ul>
<li>Táº¥t cáº£ connections sáº½ Ä‘Æ°á»£c LB phÃ¢n táº£i dá»±a trÃªn thuáº­t toÃ¡n Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh.</li>
<li>Client sáº½ thá»±c hiá»‡n chia táº£i <strong>tá»«ng request</strong> trÃªn <strong>tá»«ng connection</strong> á»Ÿ trong pool</li>
</ul>
<p>Tuy nhiÃªn, chi phÃ­ Ä‘á»ƒ hiá»‡n thá»±c client sáº½ cao hÆ¡n vÃ¬ chÃºng ta cáº§n quáº£n lÃ½ pool cÅ©ng nhÆ° chá»n connection Ä‘á»ƒ gá»­i request.</p>
<p><img src="img/grpc-loadbalacning-lb-proxy.png" alt="grpc-loadbalacning-lb-proxy" /></p>
<p><em><strong>Äiá»u gÃ¬ sáº½ xáº£y ra khi scale server?</strong></em></p>
<p>Khi má»™t server má»›i Ä‘Æ°á»£c thÃªm vÃ o cá»¥m backend, náº¿u pool á»Ÿ client cá»§a chÃºng ta Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n sá»‘ connection tá»‘i Ä‘a thÃ¬ cÃ¡ch lÃ m nÃ y gáº·p váº¥n Ä‘á» lá»›n, sáº½ khÃ´ng cÃ³ connection má»›i nÃ o Ä‘Æ°á»£c khá»Ÿi táº¡o Ä‘áº¿n server má»›i vÃ  dáº«n Ä‘áº¿n sá»± quÃ¡ táº£i á»Ÿ cÃ¡c server Ä‘ang cÃ³, dáº«n Ä‘áº¿n sáº­p server náº¿u sá»‘ lÆ°á»£ng request tÄƒng. Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, chÃºng ta cáº§n cÃ³ cÆ¡ cháº¿ refresh pool, má»—i connection trong pool sáº½ cÃ³ 1 thá»i gian sá»‘ng nháº¥t Ä‘á»‹nh, client sáº½ cháº¡y 1 job Ä‘á»ƒ refresh pool theo cÆ¡ cháº¿ nhÆ°:</p>
<ul>
<li>ÄÃ³ng nhá»¯ng connection Ä‘Ã£ háº¿t thá»i gian sá»‘ng.</li>
<li>ÄÃ³ng nhá»¯ng connection bá»‹ lá»—i.</li>
<li>Khá»Ÿi táº¡o connection má»›i thÃ´ng qua LB.</li>
</ul>
<p>Äiá»u nÃ y Ä‘áº£m báº£o connection sáº½ Ä‘Æ°á»£c chia táº£i Ä‘á»u Ä‘áº¿n cÃ¡c server, tuy nhiÃªn chÃºng ta cáº§n tÃ­nh toÃ¡n kÄ© nhá»¯ng sá»‘ liá»‡u trÃªn dá»±a trÃªn Ä‘áº·c Ä‘iá»ƒm chá»‹u táº£i cá»§a tá»«ng service, viá»‡c nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c lÃ m thÃ´ng qua quÃ¡ trÃ¬nh <code>benchmark</code> há»‡ thá»‘ng.</p>
<h3><a href="#layer-7" aria-hidden="true" class="anchor" id="layer-7"></a>Layer 7</h3>
<p>Khi LB hoáº¡t Ä‘á»™ng á»Ÿ <code>layer 7</code>, táº§ng á»©ng dá»¥ng, nÃ³ sáº½ sá»­ dá»¥ng cÃ¡c thÃ´ng tin vá» request Ä‘á»ƒ cÃ¢n báº±ng táº£i, cÅ©ng vá»›i vÃ­ dá»¥ client táº¡o 1 connection tá»›i LB nhÆ° á»Ÿ trÃªn rá»“i gá»­i requests, lÃºc nÃ y LB sáº½ cÃ¢n báº±ng táº£i tá»«ng request má»™t tá»›i cÃ¡c backend server dá»±a trÃªn cÃ¡c thuáº­t toÃ¡n Ä‘Æ°á»£c cáº¥u hÃ¬nh.</p>
<p><img src="img/grpc-loadbalacning-L7.png" alt="/grpc-loadbalacning-L7" /></p>
<p><em><strong>Loáº¡i bá» load balancer?</strong></em></p>
<p>Äá»‘i vá»›i nhá»¯ng há»‡ thá»‘ng yÃªu cáº§u kháº¯t khe vá» hiá»‡u nÄƒng, sá»­ dá»¥ng load balancer cÃ³ láº½ khÃ´ng pháº£i lÃ  giáº£i phÃ¡p tá»‘t. Client cÃ³ má»™t lá»£i tháº¿ khi sá»­ dá»¥ng load balancer lÃ  nÃ³ khÃ´ng cáº§n pháº£i quan tÃ¢m Ä‘áº¿n Ä‘á»‹a chá»‰ IP cá»¥ thá»ƒ cá»§a backend hay nhá»¯ng thá»© khÃ¡c liÃªn quan Ä‘áº¿n háº¡ táº§ng, táº¥t cáº£ nhá»¯ng thá»© nÃ³ cáº§n pháº£i biáº¿t lÃ  Ä‘á»‹a chá»‰ cá»§a load balancer, náº¿u chÃºng ta khÃ´ng sá»­ dá»¥ng load balancer, má»™t váº¥n Ä‘á» má»›i xuáº¥t hiá»‡n, <strong>lÃ m tháº¿ nÃ o Ä‘á»ƒ client vÃ  server tÃ¬m tháº¥y nhau?</strong></p>
<p>ÄÃ¢y lÃ  cÃ¢u há»i kinh Ä‘iá»ƒn gáº¯n liá»n vá»›i thuáº­t ngá»¯ <code>service discovery</code>, cÃ³ má»™t service thá»© 3 Ä‘á»©ng ra lÃ m cáº§u ná»‘i giá»¯a client vÃ  server, service nÃ y lÆ°u thÃ´ng tin cá»§a server vÃ  tráº£ lá»i má»—i khi client há»i hoáº·c chá»§ Ä‘á»™ng thÃ´ng bÃ¡o má»—i khi cÃ³ sá»± thay Ä‘á»•i. Khi client cÃ³ Ä‘Æ°á»£c Ä‘á»‹a chá»‰ cá»§a cÃ¡c server thÃ´ng qua service thá»© 3 nÃ y, nÃ³ sáº½ khá»Ÿi táº¡o connection trá»±c tiáº¿p Ä‘áº¿n cÃ¡c server vÃ  <strong>chia táº£i request</strong> trÃªn cÃ¡c connection nÃ y, viá»‡c load balancing Ä‘Ã£ trá»Ÿ thÃ nh <code>client-side load balacing</code>, <code>gRPC client</code> Ä‘ang Ä‘áº£m nhiá»‡m viá»‡c cÃ¢n báº±ng táº£i, khi mÃ¬nh nÃ³i Ä‘áº¿n <code>gRPC client</code>, tá»©c lÃ  viá»‡c xá»­ lÃ½ nÃ y sáº½ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi <code>gRPC</code>, láº­p trÃ¬nh viÃªn khÃ´ng cáº§n hiá»‡n thá»±c thÃªm gÃ¬.</p>
<p><img src="img/grpc-service-discovery.png" alt="grpc-service-discovery" /></p>
<p>Äá»ƒ tÄƒng hiá»‡u nÄƒng cÅ©ng nhÆ° throughput vá» máº·t sá»‘ lÆ°á»£ng request, chÃºng ta cÅ©ng cÃ³ thá»ƒ Ã¡p dá»¥ng kÄ© thuáº­t pooling á»Ÿ phÃ­a client cho phÆ°Æ¡ng phÃ¡p nÃ y.</p>
<h2><a href="#tá»•ng-káº¿t" aria-hidden="true" class="anchor" id="tá»•ng-káº¿t"></a>Tá»•ng káº¿t</h2>
<p>á» bÃ i viáº¿t nÃ y, mÃ¬nh Ä‘Ã£ phÃ¢n tÃ­ch Ã½ tÆ°á»Ÿng load balancing grpc, cÃ³ 2 Ä‘iá»u cáº§n hiá»ƒu rÃµ Ä‘á»ƒ trÃ¡nh mÆ¡ há»“ trong lÃºc hiá»‡n thá»±c cÃ¡c phÆ°Æ¡ng phÃ¡p nÃ y:</p>
<ul>
<li><code>connection-based load balancing:</code> chia táº£i tá»«ng connection Ä‘áº¿n tá»«ng backend server, nhá»¯ng connection nÃ y cÃ³ tÃ­nh cháº¥t <code>long-lived</code>.</li>
<li><code>request-based load balancing:</code> chia táº£i tá»«ng request Ä‘áº¿n tá»«ng connection, cÃ³ thá»ƒ hiá»ƒu chia táº£i á»Ÿ táº§ng á»©ng dá»¥ng.</li>
</ul>
<p>CÃ³ nhiá»u phÆ°Æ¡ng phÃ¡p Ä‘á»ƒ hiá»‡n thá»±c cÃ¡c Ã½ tÆ°á»Ÿng nÃ y trong cÃ¡c há»‡ thá»‘ng thá»±c táº¿, á»Ÿ cÃ¡c bÃ i tiáº¿p theo, mÃ¬nh sáº½ Ä‘i vÃ o hiá»‡n thá»±c chÃºng Ä‘á»ƒ lÃ m rÃµ hÆ¡n pháº§n lÃ½ thuyáº¿t nÃ y.</p>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/networking.html'>networking</a><a class='topic-tag' href='/tags/gRPC.html'>gRPC</a></div>
      <!-- <div class="copyright">
                Báº¡n Ä‘Æ°á»£c toÃ n quyá»n chia sáº», trÃ­ch dáº«n hoáº·c copy, post láº¡i, nhÆ°ng vui lÃ²ng ghi rÃµ nguá»“n, tÃ¡c giáº£ vÃ  khÃ´ng lÃ m thay Ä‘á»•i ná»™i dung bÃ i viáº¿t. Náº¿u khÃ´ng lÃ m váº­y, thÃ¬ OK, cÅ©ng ko sao, sáº½ cÃ³ thiÃªn lÃ´i thay ta dÃ²m ngÃ³ nhÃ  ngÆ°Æ¡i. ğŸ˜ˆ
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dangngoctam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>