<html>

<head>
  <title>gRPC Load balancing (4) - Service mesh | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script src="../js/toc.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container has-toc navigation-box">
            <p><a href="/">&larr; Quay v·ªÅ trang ch·ªß</a></p>
        </div>
  <div class="container has-toc">
    <div class="table-of-contents">
        <div class="toc-title">M·ª•c l·ª•c</div>
        <ul class="toc-list">  <li><a href="#service-mesh" class="toc-link toc-level-2"><span class="toc-hash">#</span> Service mesh</a></li>
  <li><a href="#service-mesh-trong-k8s" class="toc-link toc-level-2"><span class="toc-hash">#</span> Service mesh trong K8s</a></li>
  <li><a href="#hien-thuc-kiem-tra" class="toc-link toc-level-2"><span class="toc-hash">#</span> Hi·ªán th·ª±c / Ki·ªÉm tra</a></li>
  <li><a href="#kiem-tra" class="toc-link toc-level-2"><span class="toc-hash">#</span> Ki·ªÉm tra</a></li>
  <li><a href="#traffic-managementhttpsistio-iolatestdocsconceptstraffic-managementintroducing-istio-traffic-management" class="toc-link toc-level-2"><span class="toc-hash">#</span> [Traffic management](https://istio.io/latest/docs/concepts/traffic-management/#introducing-istio-traffic-management)</a></li>
  <li><a href="#danh-gia" class="toc-link toc-level-2"><span class="toc-hash">#</span> ƒê√°nh gi√°</a></li>
  <li><a href="#tong-ket" class="toc-link toc-level-2"><span class="toc-hash">#</span> T·ªïng k·∫øt</a></li>
  <li><a href="#ma-nguon" class="toc-link toc-level-2"><span class="toc-hash">#</span> M√£ ngu·ªìn</a></li>
  <li><a href="#tham-khao" class="toc-link toc-level-2"><span class="toc-hash">#</span> Tham kh·∫£o</a></li></ul>
    </div>
    <div class="main">
      <h1>gRPC Load balancing (4) - Service mesh</h1>
      <p>Ti·∫øp theo v·ªõi chu·ªói b√†i t√¨m hi·ªÉu <code>gRPC load balancing</code>, b√†i vi·∫øt h√¥m nay th·∫£o lu·∫≠n v·ªÅ vi·ªác s·ª≠ d·ª•ng service mesh ƒë·ªÉ c√¢n b·∫±ng t·∫£i gRPC trong k8s. Ch·ªß ƒë·ªÅ ch√≠nh v·∫´n l√† <code>gRPC load balancing</code> n√™n nh·ªØng ki·∫øn th·ª©c kh√°c m√¨nh ch·ªâ l∆∞·ªõt qua ·ªü m·ª©c v·ª´a ƒë·ªß ƒë·ªÉ c√°c b·∫°n c√≥ th·ªÉ theo d√µi b√†i vi·∫øt.</p>
<h2 id="service-mesh">Service mesh</h2>
<p><strong>Service mesh l√† g√¨?</strong></p>
<p>Service mesh l√† c√¥ng c·ª• t·∫°o ra m·ªôt l·ªõp h·∫° t·∫ßng x·ª≠ l√Ω vi·ªác giao ti·∫øp gi·ªØa c√°c service trong ·ª©ng d·ª•ng, c√≥ m·ªôt s·ªë t√≠nh nƒÉng n·ªïi b·∫≠t nh∆∞:</p>
<ul>
<li>Service discovery</li>
<li>Load balancing</li>
<li>mTLS</li>
<li>Observability</li>
<li>Traceability</li>
</ul>
<p>gi√∫p t√°ch r·ªùi nh·ªØng ch·ª©c nƒÉng kh√¥ng li√™n quan ƒë·∫øn x·ª≠ l√Ω business ra kh·ªèi ph·∫ßn code c·ªßa ·ª©ng d·ª•ng.</p>
<p>Ki·∫øn tr√∫c c·ªßa 1 service mesh:</p>
<p><img src="img/service-mesh.png" alt="service-mesh" /></p>
<p>Nh∆∞ b·∫°n c√≥ th·ªÉ th·∫•y, c√≥ 2 th√†nh ph·∫ßn ch√≠nh trong service mesh:</p>
<ul>
<li><code>Control plane</code>: ch·ªãu tr√°ch nhi·ªám ƒëi·ªÅu khi·ªÉn, c·∫•u h√¨nh c√°c rule ƒë·ªÉ qu·∫£n l√Ω mesh.</li>
<li><code>Data plane</code>: hi·ªán th·ª±c c√°c rule t·ª´ <code>control plane</code>, x·ª≠ l√Ω qu√° tr√¨nh giao ti·∫øp gi·ªØa c√°c service trong mesh b·∫±ng <code>sidecar proxy</code>, th√†nh ph·∫ßn ƒë∆∞·ª£c tri·ªÉn khai c√πng v·ªõi service.</li>
</ul>
<h2 id="service-mesh-trong-k8s">Service mesh trong K8s</h2>
<p>M√¨nh s·ª≠ d·ª•ng <code>Isito - Envoy proxy</code> ƒë·ªÉ hi·ªán th·ª±c trong b√†i vi·∫øt n√†y.</p>
<p><em><strong><a href="https://istio.io/latest/docs/ops/deployment/architecture/">Isito - Envoy</a></strong></em></p>
<p>Isito l√† m·ªôt c√¥ng c·ª• tri·ªÉn khai service mesh, ch√∫ng ta c√≥ th·ªÉ tri·ªÉn khai tr√™n K8s ho·∫∑c c·ª•m m√°y ·∫£o.</p>
<ul>
<li><code>Control plane</code>: Istiod.</li>
<li><code>Data plane</code>: <code>Envoy proxy</code> ƒë∆∞·ª£c tri·ªÉn khai c√πng v·ªõi service trong c√πng m·ªôt pod, <code>proxy</code> nh∆∞ m·ªôt l·ªõp b·ªçc ·ªü ngo√†i service, ch·∫∑n v√† x·ª≠ l√Ω t·∫•t c·∫£ in-bound, out-bound traffic c·ªßa service ƒë·ªÉ hi·ªán th·ª±c c√°c ch·ª©c nƒÉng li√™n quan ƒë·∫øn giao ti·∫øp.</li>
</ul>
<p><em>M√¥ h√¨nh ho·∫°t ƒë·ªông c√¢n b·∫±ng t·∫£i gRPC nh∆∞ sau:</em></p>
<p><img src="img/grpc-loadbalacning.istio-envoy.png" alt="img" /></p>
<ul>
<li><code>Istiod</code> s·∫Ω ƒë√≥ng vai tr√≤ <code>service discovery</code> v√† c·∫≠p nh·∫≠t cho <code>envoy proxy</code> khi c√≥ s·ª± thay ƒë·ªïi ·ªü backend server nh∆∞ scale-out, scale-in.</li>
<li><code>Envoy proxy</code> s·∫Ω c√¢n b·∫±ng t·∫£i <code>gRPC</code> ·ªü <code>layer 7</code> sau khi t·∫°o connection tr·ª±c ti·∫øp t·ªõi c√°c backend servers.</li>
</ul>
<p><em><strong>kube-proxy</strong></em></p>
<p>ƒê·ªÉ c√≥ s·ª± so s√°nh t·∫°i sao ch√∫ng ta c·∫ßn d√πng m·ªôt c√¥ng c·ª• ngo√†i k8s ƒë·ªÉ c√¢n b·∫±ng t·∫£i, h√£y c√πng ph√¢n t√≠ch qua nh·ªØng th√†nh ph·∫ßn s·∫µn c√≥ c·ªßa k8s.</p>
<p><code>Pod</code> (ƒë∆°n v·ªã tri·ªÉn khai c·ªßa k8s, lu·∫≠n l√Ω, bao g·ªìm 1 ho·∫∑c nhi·ªÅu container chia s·∫ª c√πng network namespace) sinh ra l√† ƒë·ªÉ ch·∫øt ƒëi :v, b·∫£n ch·∫•t n√≥ ch·ªâ l√† t·∫°m th·ªùi, m·ªói l·∫ßn ƒë∆∞·ª£c t·∫°o m·ªõi, pod l·∫°i ƒë∆∞·ª£c k8s g√°n m·ªôt ƒë·ªãa ch·ªâ IP kh√°c, n·∫øu s·ª≠ d·ª•ng tr·ª±c ti·∫øp ƒë·ªãa ch·ªâ IP trong giao ti·∫øp gi·ªØa c√°c pod hay c√°c d·ªãch v·ª• b√™n ngo√†i, vi·ªác ƒë·ªãa ch·ªâ IP thay ƒë·ªïi li√™n t·ª•c c√≥ th·ªÉ l√† 1 v·∫•n ƒë·ªÅ (t·∫°m g·ªçi chung l√† c√°c v·∫•n ƒë·ªÅ v·ªÅ <code>service discovery</code>). ƒê·ªÉ gi·∫£i quy·∫øt, k8s cung c·∫•p kh√°i ni·ªám <code>service</code>, t·∫°o ra m·ªôt ƒëi·ªÉm ƒëi v√†o duy nh·∫•t cho c√°c request t·ª´ ph√≠a client.</p>
<p>Service trong K8s s·ª≠ d·ª•ng <code>kube-proxy</code> ƒë·ªÉ th·ª±c hi·ªán vi·ªác giao ti·∫øp network, <code>kube-proxy</code> s·ª≠ d·ª•ng <code>iptables</code> ƒë·ªÉ ƒëi·ªÅu chuy·ªÉn c√°c g√≥i tin t·ª´ client ƒë·∫øn pod ƒëang ch·∫°y server, ho·∫°t ƒë·ªông ·ªü <code>layer 4</code>, ·ªü vai tr√≤ n√†y n√≥ gi·ªëng nh∆∞ m·ªôt load balancing proxy ho·∫°t ƒë·ªông ·ªü <code>layer 4</code>, v√† c√°c v·∫•n ƒë·ªÅ c·ªßa proxy layer 4 th√¨ m√¨nh ƒë√£ ph√¢n t√≠ch ·ªü c√°c b√†i tr∆∞·ªõc.</p>
<h2 id="hien-thuc-kiem-tra">Hi·ªán th·ª±c / Ki·ªÉm tra</h2>
<p>ƒê·ªÉ hi·ªán th·ª±c m√¥ h√¨nh n√†y, m√¨nh s·ª≠ d·ª•ng nh·ªØng th·ª© sau:</p>
<ul>
<li><a href="https://k3d.io">k3d</a>: ch·∫°y k8s ·ªü m√°y t√≠nh c√° nh√¢n.</li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/">kubectl</a>: t∆∞∆°ng t√°c v·ªõi c·ª•m k8s.</li>
<li><a href="https://istio.io/latest/">istio</a> &amp; <a href="https://www.envoyproxy.io/">envoy-proxy</a>: tri·ªÉn khai service mesh trong k8s.</li>
<li><a href="https://taskfile.dev/#/">task</a>: l√†m alias cho c√°c c√¥ng vi·ªác nh∆∞ build hay tri·ªÉn khai, gi√∫p ti·∫øt ki·ªán th·ªùi gian g√µ l·ªánh tr√™n terminal.</li>
</ul>
<p><em><strong>Server</strong></em></p>
<p>Ph·∫ßn code c·ªßa server ƒë∆°n gi·∫£n ch·ªâ c√≥ 2 method <code>unary</code> v√† <code>stream</code>, tr·∫£ v·ªÅ <code>pod name</code> m·ªói khi x·ª≠ l√Ω request nh·∫±m m·ª•c ƒë√≠ch th·ªëng k√™ ·ªü ph√≠a client.</p>
<p>M√¨nh tr√≠ch d·∫´n 2 method gRPC ·ªü ƒë√¢y:</p>
<ul>
<li><code>SayHello</code>: unary method c·ªßa gRPC.</li>
<li><code>SayHelloStream</code>: stream method c·ªßa gRPC.</li>
</ul>
<pre><code class="language-go">func (s *server) SayHello(ctx context.Context, req *pb.HelloRequest) (*pb.HelloResponse, error) {
	fmt.Printf(&quot;server %v receive message\n&quot;, s.serverId)
	return &amp;pb.HelloResponse{ServerId: s.serverId}, nil
}

func (s *server) SayHelloStream(stream pb.DemoService_SayHelloStreamServer) error {
	for {
		_, err := stream.Recv()
		if err != nil {
			return fmt.Errorf(&quot;failed to receive a request: %v&quot;, err)
		}
		fmt.Printf(&quot;server %v receive message\n&quot;, s.serverId)

		// Send a response back to the client
		res := &amp;pb.HelloResponse{
			ServerId: s.serverId,
		}

		// Send the response to the client
		if err := stream.Send(res); err != nil {
			return fmt.Errorf(&quot;failed to send response: %v&quot;, err)
		}
	}
}
</code></pre>
<p>ƒê·ªÉ tri·ªÉn khai server trong k8s, ch√∫ng ta c·∫ßn:</p>
<ul>
<li>Build code th√†nh docker image: <code>localhost:5001/hello-sidecar-server:latest</code>.</li>
<li>Vi·∫øt file tri·ªÉn khai <code>Deployment</code> v√† m·ªôt <code>Service</code> cho c√°c pod c·ªßa servers.</li>
</ul>
<p>·ªû ƒë√¢y m√¨nh chu·∫©n b·ªã 2 file <code>Deployment</code>, m·ª•c ƒë√≠ch l√† tri·ªÉn khai server v·ªõi 2 version kh√°c nhau.</p>
<p><img src="img/grpc-deployment-version.png" alt="grpc-deployment-version" /></p>
<p><em><strong>Client</strong></em></p>
<p>·ªû client l·∫ßn n√†y m√¨nh c≈©ng s·ª≠ d·ª•ng 2 method <code>unary</code> v√† <code>stream</code> ƒë·ªÉ ki·ªÉm tra c√°ch c√¢n b·∫±ng t·∫£i b·∫±ng <code>envoy proxy</code> v√† <code>kube-proxy</code>.</p>
<p>V·ªÅ √Ω t∆∞·ªüng ki·ªÉm tra:</p>
<ul>
<li>T·∫°o nhi·ªÅu client, m·ªói client g·ª≠i nhi·ªÅu request ƒë·ªëi v·ªõi <code>unary method</code> v√† nhi·ªÅu stream ƒë·ªëi v·ªõi <code>stream method</code>.</li>
<li>Th·ªëng k√™ s·ªë l∆∞·ª£ng request ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi m·ªói server.</li>
</ul>
<p><strong>unary test</strong></p>
<pre><code class="language-go">func unaryTest(index int, wg *sync.WaitGroup) {
	defer wg.Done()
	target := getTarget()
	conn, err := grpc.NewClient(target, grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf(&quot;connect to server %v fail: %v&quot;, target, err)
	}
	defer func() {
		_ = conn.Close()
	}()

	client := pb.NewDemoServiceClient(conn)

	responses := make(map[string]int)

	fmt.Printf(&quot;start gRPC client %v\n&quot;, index)

	for i := 0; i &lt; numberOfRequests; i++ {
		res, err := client.SayHello(context.Background(), &amp;pb.HelloRequest{Name: &quot;client&quot;})
		if err != nil {
			log.Printf(&quot;client %v failed to call SayHello: %v&quot;, index, err)
			continue
		}
		responses[res.ServerId] = responses[res.ServerId] + 1
		time.Sleep(requestInterval)
	}
	fmt.Printf(&quot;client %v make %v requests, received all response from %v server(s), detail: %+v\n&quot;, index, numberOfRequests, len(responses), responses)
}
</code></pre>
<p><strong>stream test</strong></p>
<pre><code class="language-go">func streamTest(index int, wg *sync.WaitGroup) {
	defer wg.Done()
	target := getTarget()
	conn, err := grpc.NewClient(target, grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf(&quot;connect to server %v fail: %v&quot;, target, err)
	}
	defer func() {
		_ = conn.Close()
	}()

	client := pb.NewDemoServiceClient(conn)

	responses := make(map[string]int)

	fmt.Printf(&quot;start gRPC client %v\n&quot;, index)
	stream, err := client.SayHelloStream(context.Background())
	if err != nil {
		log.Fatalf(&quot;could not call SayHello: %v&quot;, err)
	}

	for i := 0; i &lt; numberOfRequests; i++ {
		req := &amp;pb.HelloRequest{
			Name: fmt.Sprintf(&quot;client %d&quot;, i),
		}
		if err := stream.Send(req); err != nil {
			log.Fatalf(&quot;failed to send request: %v&quot;, err)
		}
		response, err := stream.Recv()
		if err != nil {
			log.Fatalf(&quot;failed to receive response: %v&quot;, err)
		}
		responses[response.ServerId] = responses[response.ServerId] + 1
	}
	if err := stream.CloseSend(); err != nil {
		log.Fatalf(&quot;failed to close stream: %v&quot;, err)
	}
	fmt.Printf(&quot;client %v make %v requests, received all response from %v server(s), detail: %+v\n&quot;, index, numberOfRequests, len(responses), responses)
}
</code></pre>
<p>Tri·ªÉn khai 2 phi√™n b·∫£n client b·∫±ng k8s c√≥ s·ª≠ d·ª•ng <code>envoy proxy</code> v√† kh√¥ng s·ª≠ d·ª•ng <code>envoy proxy</code>, c√≥ m·ªôt s·ªë ƒëi·ªÉm l∆∞u √Ω sau:</p>
<ul>
<li><code>sidecar.istio.io/inject: &quot;false&quot;</code>: ngƒÉn ch·∫∑n <code>istiod</code> inject sidecar proxy v√†o pod c·ªßa client.</li>
<li><code>hello-sidecar-backend.default.svc.cluster.local</code>: endpoint c·ªßa service backend.</li>
<li>c√°c th√¥ng s·ªë v·ªÅ s·ªë l∆∞·ª£ng gRPC client, s·ªë request hay s·ªë stream m·ªói gRPC client c√≥ th·ªÉ ƒë∆∞·ª£c thay ƒë·ªïi ·ªü file <code>Deployment</code>.</li>
</ul>
<p>V√≠ d·ª• file <code>Deployment yaml</code> tri·ªÉn khai client c√≥ <code>envoy proxy</code>.</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-sidecar-client
  labels:
    app: hello-sidecar-client
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-sidecar-client
  template:
    metadata:
      labels:
        app: hello-sidecar-client
    spec:
      containers:
      - name: hello-sidecar-client
        image: localhost:5001/hello-sidecar-client:latest
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: NAMESPACE
            value: &quot;default&quot;
          - name: GRPC_SERVER_ADDR
            value: &quot;hello-sidecar-backend.default.svc.cluster.local&quot;
          - name: GRPC_SERVER_PORT
            value: &quot;5005&quot;
          - name: CLIENT_CONNECTION
            value: &quot;3&quot;
          - name: STREAMER_PER_CONNECTION
            value: &quot;10&quot;
          - name: REQUEST_PER_CLIENT
            value: &quot;5000&quot;
        resources:
          limits:
            cpu: &quot;200m&quot;
            memory: &quot;250Mi&quot;
          requests:
            cpu: &quot;100m&quot;
            memory: &quot;100Mi&quot;
</code></pre>
<p>File <code>yaml</code> tri·ªÉn khai client kh√¥ng c√≥ <code>envoy proxy</code> ch·ªâ kh√°c ph·∫ßn <code>annotations</code>.</p>
<pre><code class="language-yaml">spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-client
  template:
    metadata:
      labels:
        app: hello-client
      annotations:
        sidecar.istio.io/inject: &quot;false&quot;
</code></pre>
<h2 id="kiem-tra">Ki·ªÉm tra</h2>
<p>Tri·ªÉn khai server v√† client b·∫±ng l·ªánh <code>task server:deploy</code> v√† <code>task client:deploy</code>.</p>
<p><img src="img/grpc-loadbalancing-deployment-sidecar.png" alt="grpc-loadbalancing-deployment-sidecar" /></p>
<p><em><strong>kube-proxy</strong></em></p>
<p><code>kube-proxy</code> c√¢n b·∫±ng t·∫£i ·ªü <code>layer 4</code> n√™n t·∫•t c·∫£ request t·ª´ 1 client s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi 1 backend server duy nh·∫•t.</p>
<p><img src="img/grpc-loadbalancing-no-sidecar-test-result.png" alt="grpc-loadbalancing-no-sidecar-test-result" /></p>
<p><em><strong>envoy-proxy</strong></em></p>
<ul>
<li><code>Envoy proxy</code> c√¢n b·∫±ng t·∫£i ·ªü <code>layer 7</code> n√™n khi ki·ªÉm tra v·ªõi <code>unary method</code>, requests t·ª´ 1 client c√≥ th·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi c·∫£ 3 backend servers.</li>
<li>ƒê·ªëi v·ªõi <code>stream method</code>, t·∫•t c·∫£ RPCs tr√™n 1 stream ƒë·ªÅu ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi 1 backend server duy nh·∫•t, ch·ª©ng minh r·∫±ng envoy hi·ªÉu ƒë∆∞·ª£c gRPC protocol.</li>
</ul>
<p><img src="img/grpc-loadbalancing-sidecar-test-result.png" alt="grpc-loadbalancing-sidecar-test-result" /></p>
<h2><a href="https://istio.io/latest/docs/concepts/traffic-management/#introducing-istio-traffic-management">Traffic management</a></h2>
<p>Trong l√∫c gi·ªõi thi·ªáu v·ªÅ service mesh, m√¨nh c√≥ ƒë·ªÅ c·∫≠p ƒë·∫øn 1 vai tr√≤ h√†ng ƒë·∫ßu c·ªßa n√≥ l√† h·ªó tr·ª£, qu·∫£n l√Ω giao ti·∫øp gi·ªØa services. Ph·∫ßn n√†y m√¨nh s·∫Ω ph√°t tri·ªÉn th√™m v√≠ d·ª• ·ªü ph·∫ßn tr∆∞·ªõc ƒë·ªÉ minh ho·∫° th√™m y·∫øu t·ªë qu·∫£n l√Ω traffic gi·ªØa c√°c service.</p>
<p>Khi ·ª©ng d·ª•ng c·ªßa b·∫°n tri·ªÉn khai m·ªôt t√≠nh nƒÉng m·ªõi, hay c·∫≠p nh·∫≠t t√≠nh nƒÉng c≈© v√† b·∫°n ch·ªâ mu·ªën tri·ªÉn khai ƒë·∫øn m·ªôt nh√≥m nh·ªè ng∆∞·ªùi d√πng, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng c√°c c·∫•u h√¨nh routing ƒë·ªÉ th·ª±c hi·ªán vi·ªác n√†y b·∫±ng c√°ch:</p>
<ul>
<li>S·ª≠ d·ª•ng label ƒë·ªÉ ph√¢n bi·ªát c√°c phi√™n b·∫£n m·ªõi c·ªßa server.</li>
<li>C·∫•u h√¨nh routing ƒë·ªÉ thay ƒë·ªïi t·ªâ l·ªá traffic ƒë·∫øn phi√™n b·∫£n c≈© v√† m·ªõi.</li>
</ul>
<p>ƒê·ªÉ minh ho·∫° v√≠ d·ª• n√†y, m√¨nh s·ª≠ d·ª•ng th√™m 2 th√†nh ph·∫ßn c·ªßa Istio l√† <code>VirtualService</code> v√† <code>DestinationRule</code>:</p>
<ul>
<li><code>VirtualService</code>: ƒë·ªãnh nghƒ©a c√°ch request ƒë∆∞·ª£c g·ª≠i t·ªõi m·ªôt ƒë·ªãa ch·ªâ.</li>
<li><code>DestinationRule</code>: ƒë·ªãnh nghƒ©a c√°ch request ƒë∆∞·ª£c g·ª≠i ƒë·∫øn c√°c pod sau khi ƒë∆∞·ª£c √°p d·ª•ng ch√≠nh s√°ch routing t·ª´ <code>VirtualService</code>, b·∫°n c√≥ th·ªÉ hi·ªÉu c√≥ 2 b·∫≠c routing ·ªü ƒë√¢y.</li>
</ul>
<p><img src="img/istio-envoy-mesh-traffic.png" alt="istio-envoy-mesh-traffic" /></p>
<p>T·ªâ l·ªá gi·ªØa 2 phi√™n b·∫£n c·ªßa server l√† 3:1.</p>
<p>ƒê·ªÉ ch·∫°y ch∆∞∆°ng tr√¨nh, ch√∫ng ta ch·ªâ c·∫ßn ch·∫°y <code>task server:deploy</code> v√† <code>task client:deploy</code> sau khi ƒë√£ c·∫≠p nh·∫≠t c√°c file yaml.</p>
<p><strong>K·∫øt qu·∫£ cho th·∫•y ƒë√∫ng v·ªõi ch√∫ng ta k√¨ v·ªçng</strong>, t·ªâ l·ªá request ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi 2 phi√™n b·∫£n c·ªßa server g·∫ßn b·∫±ng 3:1.</p>
<p><img src="img/grpc-weight-routing-service-mesh-result.png" alt="grpc-weight-routing-service-mesh-result" /></p>
<h2 id="danh-gia">ƒê√°nh gi√°</h2>
<p>M√¨nh ch·ªâ t·∫≠p trung ƒë√°nh gi√° ∆∞u/nh∆∞·ª£c ƒëi·ªÉm li√™n quan ƒë·∫øn t√≠nh nƒÉng c√¢n b·∫±ng t·∫£i.</p>
<p><em><strong>∆Øu ƒëi·ªÉm</strong></em></p>
<ul>
<li>Service mesh cung c·∫•p c∆° ch·∫ø c√¢n b·∫±ng t·∫£i ·ªü t·∫ßng ·ª©ng d·ª•ng, gi·∫£i quy·∫øt ƒë∆∞·ª£c v·∫•n ƒë·ªÅ c√¢n b·∫±ng t·∫£i connection c·ªßa <code>kube-proxy</code>.</li>
<li>Cung c·∫•p c∆° ch·∫ø <code>service discovery</code>.</li>
<li>H·ªó tr·ª£ ƒëa d·∫°ng c√°c ch·∫ø ƒë·ªô c√¢n b·∫±ng t·∫£i, ph√π h·ª£p v·ªõi c√°c ·ª©ng d·ª•ng tri·ªÉn khai ph·ª©c t·∫°p.</li>
</ul>
<p><em><strong>Nh∆∞·ª£c ƒëi·ªÉm</strong></em></p>
<ul>
<li>TƒÉng ƒë·ªô ph·ª©c t·∫°p trong c√°c m√¥ h√¨nh tri·ªÉn khai.</li>
<li>Th√™m 1 l·ªõp v√†o vi·ªác giao ti·∫øp gi·ªØa c√°c service, tƒÉng latency c·ªßa request c≈©ng nh∆∞ kh√≥ debug khi c√≥ l·ªói x·∫£y ra.</li>
</ul>
<h2 id="tong-ket">T·ªïng k·∫øt</h2>
<p>Qua b√†i vi·∫øt n√†y, m√¨nh ƒë√£ hi·ªán th·ª±c service mesh trong K8s ƒë·ªÉ c√¢n b·∫±ng t·∫£i gRPC c≈©ng nh∆∞ ki·ªÉm tra l·∫°i c√°c l√Ω thuy·∫øt ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch ·ªü c√°c b√†i vi·∫øt tr∆∞·ªõc. M·ªôt s·ªë ki·∫øn th·ª©c quan tr·ªçng c·∫ßn l∆∞u √Ω:</p>
<ul>
<li>M√¥ h√¨nh ho·∫°t ƒë·ªông c·ªßa service mesh, side-car pattern.</li>
<li><code>Kube-proxy</code> ho·∫°t ƒë·ªông c√¢n b·∫±ng t·∫£i ·ªü <code>L4</code>.</li>
<li><code>Envoy proxy</code> ho·∫°t ƒë·ªông c√¢n b·∫±ng t·∫£i ·ªü <code>L7</code>.</li>
<li><code>Istio v√† Envoy proxy</code> h·ªó tr·ª£ ƒëa d·∫°ng c√°c c·∫•u h√¨nh qu·∫£n l√Ω traffic.</li>
</ul>
<h2 id="ma-nguon">M√£ ngu·ªìn</h2>
<p>B·∫°n c√≥ th·ªÉ tham kh·∫£o m√£ ngu·ªìn ·ªü repository <a href="https://github.com/dntam00/grpc-loadbalancing/tree/main/sidecar-envoy">grpc-loadblancing</a>.</p>
<h2 id="tham-khao">Tham kh·∫£o</h2>
<ul>
<li><a href="https://istio.io/">Istio</a></li>
<li><a href="https://www.manning.com/books/istio-in-action">Istio in Action</a> by Christian E. Posta and Rinor Maloku.</li>
</ul>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/networking.html'>networking</a><a class='topic-tag' href='/tags/gRPC.html'>gRPC</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>