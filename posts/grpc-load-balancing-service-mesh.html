<html>

<head>
  <title>gRPC Load balancing - service mesh | Tam's Blog</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Tam's Blog</span></a>
  </div>
  <div class="container">
    <div class="main">
      <p><a href="/">&lt;- Quay v·ªÅ trang ch·ªß</a></p>
      <h1>gRPC Load balancing - service mesh</h1>
      <p>Ti·∫øp theo v·ªõi chu·ªói b√†i t√¨m hi·ªÉu <code>gRPC load balancing</code>, b√†i vi·∫øt h√¥m nay th·∫£o lu·∫≠n v·ªÅ vi·ªác s·ª≠ d·ª•ng service mesh ƒë·ªÉ c√¢n b·∫±ng t·∫£i gRPC trong K8s. Ch·ªß ƒë·ªÅ ch√≠nh v·∫´n l√† <code>gRPC load balancing</code> n√™n nh·ªØng ki·∫øn th·ª©c kh√°c m√¨nh ch·ªâ l∆∞·ªõt qua ·ªü m·ª©c v·ª´a ƒë·ªß ƒë·ªÉ c√°c b·∫°n c√≥ th·ªÉ theo d√µi b√†i vi·∫øt.</p>
<h2><a href="#service-mesh" aria-hidden="true" class="anchor" id="service-mesh"></a>Service mesh</h2>
<p><strong>Service mesh l√† g√¨?</strong></p>
<p>Service mesh l√† c√¥ng c·ª• t·∫°o ra m·ªôt l·ªõp h·∫° t·∫ßng x·ª≠ l√Ω vi·ªác giao ti·∫øp gi·ªØa c√°c service trong ·ª©ng d·ª•ng, c√≥ m·ªôt s·ªë t√≠nh nƒÉng n·ªïi b·∫≠t nh∆∞:</p>
<ul>
<li>Service discovery</li>
<li>Load balancing</li>
<li>mTLS</li>
<li>Observability</li>
<li>Traceability</li>
</ul>
<p>Ki·∫øn tr√∫c c·ªßa 1 service mesh:</p>
<p><img src="img/service-mesh.png" alt="service-mesh" /></p>
<p>Nh∆∞ b·∫°n c√≥ th·ªÉ th·∫•y, c√≥ 2 th√†nh ph·∫ßn ch√≠nh trong service mesh:</p>
<ul>
<li><code>Control plane</code>: ch·ªãu tr√°ch nhi·ªám ƒëi·ªÅu khi·ªÉn, c·∫•u h√¨nh c√°c rule ƒë·ªÉ qu·∫£n l√Ω mesh.</li>
<li><code>Data plane</code>: hi·ªán th·ª±c c√°c rule t·ª´ <code>control plane</code>, x·ª≠ l√Ω qu√° tr√¨nh giao ti·∫øp gi·ªØa c√°c service trong mesh b·∫±ng <code>sidecar proxy</code>.</li>
</ul>
<h2><a href="#service-mesh-trong-k8s" aria-hidden="true" class="anchor" id="service-mesh-trong-k8s"></a>Service mesh trong K8s</h2>
<p>M√¨nh s·ª≠ d·ª•ng <code>Isito - Envoy proxy</code> ƒë·ªÉ hi·ªán th·ª±c trong b√†i vi·∫øt n√†y.</p>
<p><em><strong><a href="https://istio.io/latest/docs/ops/deployment/architecture/">Isito - Envoy</a></strong></em></p>
<p>Isito l√† m·ªôt c√¥ng c·ª• tri·ªÉn khai service mesh, ch√∫ng ta c√≥ th·ªÉ tri·ªÉn khai tr√™n K8s ho·∫∑c c·ª•m m√°y ·∫£o.</p>
<ul>
<li><code>Control plane</code>: Istiod.</li>
<li><code>Data plane</code>: <code>Envoy proxy</code> ƒë∆∞·ª£c tri·ªÉn khai c√πng v·ªõi service trong c√πng m·ªôt pod.</li>
</ul>
<p><em>M√¥ h√¨nh ho·∫°t ƒë·ªông c√¢n b·∫±ng t·∫£i gRPC nh∆∞ sau:</em></p>
<p><img src="img/grpc-loadbalacning.istio-envoy.png" alt="img" /></p>
<ul>
<li><code>Istiod</code> s·∫Ω ƒë√≥ng vai tr√≤ <code>service discovery</code> v√† c·∫≠p nh·∫≠t cho <code>envoy proxy</code> khi c√≥ s·ª± thay ƒë·ªïi ·ªü backend server nh∆∞ scale-out, scale-in.</li>
<li><code>Envoy proxy</code> s·∫Ω c√¢n b·∫±ng t·∫£i <code>gRPC</code> ·ªü <code>layer 7</code> sau khi t·∫°o connection tr·ª±c ti·∫øp t·ªõi c√°c backend servers.</li>
</ul>
<p><em><strong>kube-proxy</strong></em></p>
<p>ƒê·ªÉ c√≥ s·ª± so s√°nh t·∫°i sao ch√∫ng ta c·∫ßn d√πng m·ªôt c√¥ng c·ª• ngo√†i K8s ƒë·ªÉ c√¢n b·∫±ng t·∫£i, h√£y c√πng ph√¢n t√≠ch qua nh·ªØng th√†nh ph·∫ßn s·∫µn c√≥ c·ªßa K8s.</p>
<p><code>Service</code> trong K8s s·ª≠ d·ª•ng <code>kube-proxy</code> ƒë·ªÉ th·ª±c hi·ªán vi·ªác giao ti·∫øp network, <code>kube-proxy</code> s·ª≠ d·ª•ng <code>iptables</code> ƒë·ªÉ forward c√°c g√≥i tin t·ª´ client ƒë·∫øn pod ƒëang ch·∫°y c√°c server, ho·∫°t ƒë·ªông ch·ªß y·∫øu ·ªü <code>layer 4</code>, ·ªü vai tr√≤ n√†y n√≥ gi·ªëng nh∆∞ m·ªôt load balancing ho·∫°t ƒë·ªông ·ªü <code>layer 4</code>. N·∫øu s·ª≠ d·ª•ng <code>kube-proxy</code>, ch√∫ng ta ph·∫£i s·ª≠ d·ª•ng <code>connection pool</code> ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác c√¢n b·∫±ng t·∫£i ho·∫°t ƒë·ªông ƒë√∫ng nh∆∞ mong mu·ªën.</p>
<h2><a href="#hi·ªán-th·ª±c" aria-hidden="true" class="anchor" id="hi·ªán-th·ª±c"></a>Hi·ªán th·ª±c</h2>
<ul>
<li>M√¨nh s·ª≠ d·ª•ng <a href="https://k3d.io">k3d</a> ƒë·ªÉ ch·∫°y k8s ·ªü m√°y local v√† <a href="https://taskfile.dev/#/">task</a> ƒë·ªÉ l√†m alias cho c√°c c√¥ng vi·ªác nh∆∞ build hay tri·ªÉn khai.</li>
<li>C√†i istio v√†o cluster K8s.</li>
</ul>
<p><em><strong>Server</strong></em></p>
<p>Ph·∫ßn code c·ªßa server ƒë∆°n gi·∫£n ch·ªâ c√≥ 2 method <code>unary</code> v√† <code>stream</code>, tr·∫£ v·ªÅ <code>pod name</code> m·ªói khi x·ª≠ l√Ω request nh·∫±m m·ª•c ƒë√≠ch th·ªëng k√™ ·ªü ph√≠a client.</p>
<pre><code class="language-go">func (s *server) SayHello(ctx context.Context, req *pb.HelloRequest) (*pb.HelloResponse, error) {
	fmt.Printf(&quot;server %v receive message\n&quot;, s.serverId)
	return &amp;pb.HelloResponse{ServerId: s.serverId}, nil
}

func (s *server) SayHelloStream(stream pb.DemoService_SayHelloStreamServer) error {
	for {
		_, err := stream.Recv()
		if err != nil {
			return fmt.Errorf(&quot;failed to receive a request: %v&quot;, err)
		}
		fmt.Printf(&quot;server %v receive message\n&quot;, s.serverId)

		// Send a response back to the client
		res := &amp;pb.HelloResponse{
			ServerId: s.serverId,
		}

		// Send the response to the client
		if err := stream.Send(res); err != nil {
			return fmt.Errorf(&quot;failed to send response: %v&quot;, err)
		}
	}
}
</code></pre>
<p>Tri·ªÉn khai v·ªõi t√™n <code>hello-sidecar-server</code> v√† d·ª±ng m·ªôt <code>service</code> cho c·ª•m backend.</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-sidecar-server
  labels:
    app: hello-sidecar-server
    sidecar.istio.io/inject: &quot;true&quot;
spec:
  replicas: 3
  selector:
    matchLabels:
      app: hello-sidecar-server
  template:
    metadata:
      labels:
        app: hello-sidecar-server
    spec:
      serviceAccountName: server-user
      containers:
      - name: hello-sidecar-server
        ports:
          - protocol: TCP
            containerPort: 50051
        image: localhost:5001/hello-sidecar-server:latest
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: NAMESPACE
            value: &quot;default&quot;
        resources:
          limits:
            cpu: &quot;200m&quot;
            memory: &quot;250Mi&quot;
          requests:
            cpu: &quot;100m&quot;
            memory: &quot;100Mi&quot;
        readinessProbe:
          exec:
            command: [ &quot;/bin/grpc_health_probe&quot;, &quot;-addr=:50051&quot;, &quot;-rpc-timeout=4s&quot; ]
          initialDelaySeconds: 5
          timeoutSeconds: 5
        livenessProbe:
          exec:
            command: [ &quot;/bin/grpc_health_probe&quot;, &quot;-addr=:50051&quot;, &quot;-rpc-timeout=4s&quot; ]
          timeoutSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: hello-sidecar-server
spec:
  selector:
    app: hello-sidecar-server
  ports:
    - port: 5005
      name: hello-sidecar-server
      protocol: TCP
      targetPort: 50051
</code></pre>
<p><em><strong>Client</strong></em></p>
<p>·ªû client l·∫ßn n√†y m√¨nh c≈©ng s·ª≠ d·ª•ng 2 method <code>unary</code> v√† <code>stream</code> ƒë·ªÉ ki·ªÉm tra c√°ch c√¢n b·∫±ng t·∫£i b·∫±ng <code>envoy proxy</code> v√† <code>kube-proxy</code>.</p>
<p><strong>unary test</strong></p>
<pre><code class="language-go">func unaryTest(index int, wg *sync.WaitGroup) {
	defer wg.Done()
	target := getTarget()
	conn, err := grpc.NewClient(target, grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf(&quot;connect to server %v fail: %v&quot;, target, err)
	}
	defer func() {
		_ = conn.Close()
	}()

	client := pb.NewDemoServiceClient(conn)

	responses := make(map[string]int)

	fmt.Printf(&quot;start gRPC client %v\n&quot;, index)

	for i := 0; i &lt; numberOfRequests; i++ {
		res, err := client.SayHello(context.Background(), &amp;pb.HelloRequest{Name: &quot;client&quot;})
		if err != nil {
			log.Printf(&quot;client %v failed to call SayHello: %v&quot;, index, err)
			continue
		}
		responses[res.ServerId] = responses[res.ServerId] + 1
		time.Sleep(requestInterval)
	}
	fmt.Printf(&quot;client %v make %v requests, received all response from %v server(s), detail: %+v\n&quot;, index, numberOfRequests, len(responses), responses)
}
</code></pre>
<p><strong>stream test</strong></p>
<pre><code class="language-go">func streamTest(index int, wg *sync.WaitGroup) {
	defer wg.Done()
	target := getTarget()
	conn, err := grpc.NewClient(target, grpc.WithTransportCredentials(insecure.NewCredentials()))
	if err != nil {
		log.Fatalf(&quot;connect to server %v fail: %v&quot;, target, err)
	}
	defer func() {
		_ = conn.Close()
	}()

	client := pb.NewDemoServiceClient(conn)

	responses := make(map[string]int)

	fmt.Printf(&quot;start gRPC client %v\n&quot;, index)
	stream, err := client.SayHelloStream(context.Background())
	if err != nil {
		log.Fatalf(&quot;could not call SayHello: %v&quot;, err)
	}

	for i := 0; i &lt; numberOfRequests; i++ {
		req := &amp;pb.HelloRequest{
			Name: fmt.Sprintf(&quot;client %d&quot;, i),
		}
		if err := stream.Send(req); err != nil {
			log.Fatalf(&quot;failed to send request: %v&quot;, err)
		}
		response, err := stream.Recv()
		if err != nil {
			log.Fatalf(&quot;failed to receive response: %v&quot;, err)
		}
		responses[response.ServerId] = responses[response.ServerId] + 1
	}
	if err := stream.CloseSend(); err != nil {
		log.Fatalf(&quot;failed to close stream: %v&quot;, err)
	}
	fmt.Printf(&quot;client %v make %v requests, received all response from %v server(s), detail: %+v\n&quot;, index, numberOfRequests, len(responses), responses)
}
</code></pre>
<p>Tri·ªÉn khai 2 client, c√≥ s·ª≠ d·ª•ng <code>envoy proxy</code> v√† kh√¥ng s·ª≠ d·ª•ng <code>envoy proxy</code>.</p>
<ul>
<li><code>sidecar.istio.io/inject: &quot;false&quot;</code>: ngƒÉn ch·∫∑n <code>istiod</code> inject sidecar proxy v√†o pod c·ªßa client.</li>
<li><code>hello-sidecar-server.default.svc.cluster.local</code>: endpoint c·ªßa service backend.</li>
</ul>
<p>File <code>yaml</code> tri·ªÉn khai client c√≥ <code>envoy proxy</code>.</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-sidecar-client
  labels:
    app: hello-sidecar-client
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-sidecar-client
  template:
    metadata:
      labels:
        app: hello-sidecar-client
    spec:
      containers:
      - name: hello-sidecar-client
        image: localhost:5001/hello-sidecar-client:latest
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: NAMESPACE
            value: &quot;default&quot;
          - name: GRPC_SERVER_ADDR
            value: &quot;hello-sidecar-server.default.svc.cluster.local:5005&quot;
        resources:
          limits:
            cpu: &quot;200m&quot;
            memory: &quot;250Mi&quot;
          requests:
            cpu: &quot;100m&quot;
            memory: &quot;100Mi&quot;
</code></pre>
<p>File <code>yaml</code> tri·ªÉn khai client kh√¥ng c√≥ <code>envoy proxy</code> ch·ªâ kh√°c ph·∫ßn <code>annotations</code>.</p>
<pre><code class="language-yaml">spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-client
  template:
    metadata:
      labels:
        app: hello-client
      annotations:
        sidecar.istio.io/inject: &quot;false&quot;
</code></pre>
<h2><a href="#ki·ªÉm-tra" aria-hidden="true" class="anchor" id="ki·ªÉm-tra"></a>Ki·ªÉm tra</h2>
<p>Tri·ªÉn khai server v√† client b·∫±ng l·ªánh <code>task server:deploy</code> v√† <code>task client:deploy</code>.</p>
<p><img src="img/grpc-loadbalancing-deployment-sidecar.png" alt="grpc-loadbalancing-deployment-sidecar" /></p>
<p><em><strong>kube-proxy</strong></em></p>
<p><code>kube-proxy</code> c√¢n b·∫±ng t·∫£i ·ªü <code>layer 4</code> n√™n t·∫•t c·∫£ request t·ª´ 1 client s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi 1 backend server duy nh·∫•t.</p>
<p><img src="img/grpc-loadbalancing-no-sidecar-test-result.png" alt="grpc-loadbalancing-no-sidecar-test-result" /></p>
<p><em><strong>envoy-proxy</strong></em></p>
<ul>
<li><code>Envoy proxy</code> c√¢n b·∫±ng t·∫£i ·ªü <code>layer 7</code> n√™n khi ki·ªÉm tra v·ªõi <code>unary method</code>, requests t·ª´ 1 client c√≥ th·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi c·∫£ 3 backend servers.</li>
<li>ƒê·ªëi v·ªõi <code>stream method</code>, t·∫•t c·∫£ messages tr√™n 1 stream ƒë·ªÅu ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi 1 backend server duy nh·∫•t, ƒë·∫£m b·∫£o t√≠nh ƒë√∫ng ƒë·∫Øn v·ªÅ ch·ª©c nƒÉng c·ªßa protocol.</li>
</ul>
<p><img src="img/grpc-loadbalancing-sidecar-test-result.png" alt="grpc-loadbalancing-sidecar-test-result" /></p>
<h2><a href="#t·ªïng-k·∫øt" aria-hidden="true" class="anchor" id="t·ªïng-k·∫øt"></a>T·ªïng k·∫øt</h2>
<p>Qua b√†i vi·∫øt n√†y, m√¨nh ƒë√£ hi·ªán th·ª±c service mesh trong K8s ƒë·ªÉ c√¢n b·∫±ng t·∫£i gRPC c≈©ng nh∆∞ ki·ªÉm tra l·∫°i c√°c l√Ω thuy·∫øt ƒë√£ ƒë∆∞·ª£c ph√¢n t√≠ch ·ªü c√°c b√†i vi·∫øt tr∆∞·ªõc. M·ªôt s·ªë ki·∫øn th·ª©c quan tr·ªçng c·∫ßn l∆∞u √Ω:</p>
<ul>
<li>Servie mesh v√† m√¥ h√¨nh ho·∫°t ƒë·ªông.</li>
<li><code>Kube-proxy</code> ho·∫°t ƒë·ªông c√¢n b·∫±ng t·∫£i ·ªü <code>L4</code>.</li>
<li><code>Envoy proxy</code> ho·∫°t ƒë·ªông c√¢n b·∫±ng t·∫£i ·ªü <code>L7</code>.</li>
</ul>
<h2><a href="#m√£-ngu·ªìn" aria-hidden="true" class="anchor" id="m√£-ngu·ªìn"></a>M√£ ngu·ªìn</h2>
<p>B·∫°n c√≥ th·ªÉ tham kh·∫£o m√£ ngu·ªìn ·ªü repository <a href="https://github.com/dangngoctam00/grpc-loadbalancing/tree/main/sidecar-envoy">grpc-loadblancing</a>.</p>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/networking.html'>networking</a><a class='topic-tag' href='/tags/gRPC.html'>gRPC</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dangngoctam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>