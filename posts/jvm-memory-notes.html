<html>

<head>
  <title>JVM memory | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script src="../js/toc.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container has-toc navigation-box">
            <p><a href="/">&larr; Quay vá» trang chá»§</a></p>
        </div>
  <div class="container has-toc">
    <div class="table-of-contents">
        <div class="toc-title">Má»¥c lá»¥c</div>
        <ul class="toc-list">  <li><a href="#van-de" class="toc-link toc-level-2"><span class="toc-hash">#</span> Váº¥n Ä‘á»</a></li>
  <li><a href="#reserved-vs-committed" class="toc-link toc-level-2"><span class="toc-hash">#</span> Reserved vs Committed</a></li>
  <li><a href="#giai-phap" class="toc-link toc-level-2"><span class="toc-hash">#</span> Giáº£i phÃ¡p</a></li>
  <li><a href="#off-heap-memory" class="toc-link toc-level-2"><span class="toc-hash">#</span> Off-heap memory</a></li>
  <li><a href="#tong-ket" class="toc-link toc-level-2"><span class="toc-hash">#</span> Tá»•ng káº¿t</a></li>
  <li><a href="#tham-khao" class="toc-link toc-level-2"><span class="toc-hash">#</span> Tham kháº£o</a></li></ul>
    </div>
    <div class="main">
      <h1>JVM memory</h1>
      <h2 id="van-de">Váº¥n Ä‘á»</h2>
<p>Tuáº§n rá»“i Ä‘Æ°á»£c má»™t Ä‘á»“ng nghiá»‡p há»i vá» viá»‡c service hay bá»‹ <code>OOM (Out Of Memory)</code> trÃªn mÃ´i trÆ°á»ng DEV, vá»«a hay thÃ¡ng trÆ°á»›c há»c lÃ½ thuyáº¿t vá» JVM nÃªn nay mang vÃ o thá»±c hÃ nh thá»­, trong quÃ¡ trÃ¬nh lÃ m thÃ¬ nháº­n cÃ³ nhiá»u thá»© báº£n thÃ¢n Ä‘ang hiá»ƒu sai hoáº·c chÆ°a hiá»ƒu rÃµ.</p>
<p>Má»™t sá»‘ ngá»¯ cáº£nh cá»§a service:</p>
<ul>
<li>MÃ£ nguá»“n Java 8.</li>
<li>Sá»­ dá»¥ng G1C garbage collector.</li>
<li>Webserver xÃ i Tomcat truyá»n thá»‘ng, webclient xÃ i Webflux vá»›i Netty.</li>
<li>Triá»ƒn khai trÃªn k8s vá»›i sidecar pattern, istio proxy.</li>
</ul>
<!-- ![jvm-memory](img/k8s_everywhere.png) -->
<p>Äáº§u tiÃªn thÃ¬ tháº¥y container service bá»‹ <code>OOMKilled</code>:</p>
<ul>
<li>Pod khÃ´ng bá»‹ xoÃ¡ Ä‘i.</li>
<li>Container bá»‹ restart nhiá»u láº§n bá»Ÿi k8s do vÆ°á»£t quÃ¡ giá»›i háº¡n bá»™ nhá»› Ä‘Æ°á»£c thiáº¿t láº­p.</li>
</ul>
<p>VÃ o xem memory cá»§a container thÃ¬ Ä‘Ãºng lÃ  <code>loanh quanh 2GiB</code>, vá»«a Ä‘Ãºng vá»›i giÃ¡ trá»‹ giá»›i háº¡n. Váº­y cÃ³ pháº£i do á»©ng dá»¥ng cÃ³ váº¥n Ä‘á» hay con sá»‘ 2GiB quÃ¡ tháº¥p?</p>
<p>BÆ°á»›c Ä‘áº§u tiÃªn nghÄ© tá»›i lÃ  heapdump:</p>
<pre><code>jcmd 1 GC.heap_dump &lt;path&gt;
</code></pre>
<p>Äiá»u báº¥t ngá» lÃ  káº¿t quáº£ cá»§a heapdump chá»‰ loanh quanh <code>250MB</code>.</p>
<p><img src="img/jvm_memory_heapdump.png" alt="heapdump" /></p>
<p>Con sá»‘ khÃ¡ nhá» so vá»›i 2GiB, váº­y pháº£i tiáº¿p tá»¥c sá»­ dá»¥ng cháº¿ Ä‘á»™ theo dÃµi memory cá»§a JVM Ä‘á»ƒ nghiÃªn cá»©u tiáº¿p.
Khi cháº¡y chÆ°Æ¡ng trÃ¬nh, cáº§n thÃªm tuá»³ chá»n sau:</p>
<pre><code>-XX:NativeMemoryTracking=summary
</code></pre>
<p>Sau Ä‘Ã³, cÃ³ thá»ƒ sá»­ dá»¥ng lá»‡nh <code>jcmd</code> Ä‘á»ƒ láº¥y thÃ´ng tin:</p>
<pre><code>jcmd &lt;pid&gt; VM.native_memory summary scale=MB
</code></pre>
<p><img src="img/jvm_memory_native_memory_tracking.png" alt="native_memory_tracking" /></p>
<p>Thoáº¡t Ä‘áº§u nhÃ¬n vÃ o pháº§n <code>Total</code>, tháº¥y con sá»‘ <code>committed: 2131MB</code> cÃ²n lá»›n hÆ¡n cáº£ giá»›i háº¡n 2GiB cá»§a container, tháº¥y cÅ©ng hÆ¡i láº¡, táº¡i vÃ¬ mÃ¬nh Ä‘ang vÃ o bÃªn trong container Ä‘á»ƒ cháº¡y lá»‡nh mÃ , náº¿u lÆ¡n hÆ¡n thÃ¬ container Ä‘Ã£ bá»‹ kill vÃ  mÃ¬nh khÃ´ng thá»ƒ truy cáº­p Ä‘Æ°á»£c rá»“i.</p>
<p>Ok báº¯t Ä‘áº§u Ä‘i tÃ¬m hiá»ƒu vá» cÃ¡c con sá»‘ trong pháº§n káº¿t quáº£ nÃ y, thÃ¬ tháº¥y JVM cÃ³ 1 bug liÃªn quan Ä‘áº¿n NMT (Native Memory Tracking) trÃªn cÃ¡c phiÃªn báº£n Java 8 cÅ©:</p>
<ul>
<li><a href="https://bugs.openjdk.org/browse/JDK-8191369">https://bugs.openjdk.org/browse/JDK-8191369</a></li>
</ul>
<p>Cá»¥ thá»ƒ lÃ  con sá»‘ <code>committed</code> trong pháº§n <code>stack memory</code> Ä‘Æ°á»£c hiá»ƒn thá»‹ báº±ng vá»›i sá»‘ <code>reserved</code>. Váº­y káº¿t luáº­n Ä‘áº§u tiÃªn lÃ  giÃ¡ trá»‹ <code>committed</code> á»Ÿ pháº§n <code>Total</code> sáº½ pháº£i nhá» hÆ¡n sá»‘ trong hÃ¬nh.</p>
<h2 id="reserved-vs-committed">Reserved vs Committed</h2>
<p>TrÆ°á»›c khi Ä‘i tiáº¿p thÃ¬ cáº§n hiá»ƒu vá» 2 khÃ¡i niá»‡m <code>reserved</code> vÃ  <code>committed</code> trong quáº£n lÃ½ bá»™ nhá»› cá»§a JVM:</p>
<ul>
<li><code>Reserved memory</code>: kÃ­ch thÆ°á»›c vÃ¹ng nhá»› Ä‘Æ°á»£c Ä‘áº£m báº£o bá»Ÿi OS lÃ  sáº½ sáºµn sÃ ng cung cáº¥p cho JVM náº¿u Ä‘Æ°á»£c yÃªu cáº§u, cÃ³ thá»ƒ hiá»ƒu lÃ  lá»i há»©a :V.</li>
<li><code>Committed memory</code>: kÃ­ch thÆ°á»›c vÃ¹ng nhá»› thá»±c táº¿ Ä‘Ã£ Ä‘Æ°á»£c OS cáº¥p phÃ¡t cho JVM Ä‘á»ƒ sá»­ dá»¥ng.</li>
</ul>
<p>Váº­y nÃªn, <code>reserved</code> luÃ´n luÃ´n lá»›n hÆ¡n hoáº·c báº±ng <code>committed</code>.</p>
<p>Trong 2 sá»‘ trÃªn thÃ¬ giÃ¡ trá»‹ <code>committed</code> sáº½ Ä‘Æ°á»£c k8s sá»­ dá»¥ng Ä‘á»ƒ so sÃ¡nh vá»›i giá»›i háº¡n bá»™ nhá»› cá»§a container.</p>
<p><em><strong>CÃ¢u há»i quan trá»ng:</strong></em> cÃ³ pháº£i táº¥t cáº£ vÃ¹ng nhá»› trong pháº§n <code>committed</code> Ä‘á»u Ä‘ang chá»©a dá»¯ liá»‡u (objects, metadata,...), cÃ³ thá»ƒ hiá»ƒu lÃ  <code>Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng</code>?</p>
<p>Ban Ä‘áº§u thÃ¬ cÅ©ng nghÄ© lÃ  váº­y, cho tá»›i khi hiá»ƒu Ä‘Æ°á»£c Ã½ nghÄ©a cá»§a nÃ³ vÃ  xem láº¡i file <code>heapdump</code> á»Ÿ trÃªn. CÃ¢u tráº£ lá»i chÃ­nh xÃ¡c lÃ  khÃ´ng, JVM cÃ³ thá»ƒ Ä‘Ã¡nh dáº¥u sá»Ÿ há»¯u vÃ¹ng nhá»› nhÆ°ng khÃ´ng nháº¥t thiáº¿t pháº£i cáº¥p phÃ¡t dá»¯ liá»‡u lÃªn Ä‘Ã³.</p>
<h2 id="giai-phap">Giáº£i phÃ¡p</h2>
<p>NhÃ¬n vÃ o pháº§n <code>Heap</code> thÃ¬ tháº¥y giÃ¡ trá»‹ <code>committed</code> báº±ng vá»›i <code>reserved</code> lÃ  <code>1Gib</code>, chiáº¿m 50% sá»‘ giá»›i háº¡n cá»§a container, con sá»‘ nÃ y Ä‘Æ°á»£c cáº¥u hÃ¬nh tá»« Ä‘Ã¢u?</p>
<p>Khi nghiÃªn cá»©u vá» process JVM thÃ¬ cÃ³ má»™t vÃ i lá»‡nh quan trá»ng Ä‘á»ƒ xem cÃ¡c thÃ´ng sá»‘ cáº¥u hÃ¬nh:</p>
<pre><code>jcmd &lt;pid&gt; VM.flags
jcmd &lt;pid&gt; VM.command_line
</code></pre>
<p>Sau khi cháº¡y 2 lá»‡nh trÃªn thÃ¬ tháº¥y cÃ³ má»™t cáº¥u hÃ¬nh liÃªn quan tá»›i Heap, Ä‘Ã³ lÃ  <code>-XX:MaxRAMFraction=2</code>.</p>
<ul>
<li><code>MaxRAMFraction</code>: xÃ¡c Ä‘á»‹nh tá»· lá»‡ pháº§n trÄƒm bá»™ nhá»› váº­t lÃ½ tá»‘i Ä‘a mÃ  JVM cÃ³ thá»ƒ sá»­ dá»¥ng cho Heap, giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  <code>4</code>, tá»©c lÃ  25% bá»™ nhá»› váº­t lÃ½.</li>
</ul>
<p>Cáº¥u hÃ¬nh nÃ y giáº£i thÃ­ch giÃ¡ trá»‹ <code>reserved</code> cá»§a Heap lÃ  <code>1Gib</code>, vÃ¬ giá»›i háº¡n bá»™ nhá»› cá»§a container lÃ  <code>2Gib</code>.</p>
<p>Quay láº¡i vá»›i giÃ¡ trá»‹ tháº­t sá»± sá»­ dá»¥ng cá»§a <code>Heap</code>, vÃ¬ chá»‰ loanh quanh <code>250MB</code> nÃªn nghÄ© vá» phÆ°Æ¡ng Ã¡n Ä‘áº§u tiÃªn lÃ  lÃ m yÃªu cáº§u JVM tráº£ vÃ¹ng nhá»› vá» cho OS khi khÃ´ng sá»­ dá»¥ng, tÃ¬m kiáº¿m trÃªn máº¡ng thÃ¬ tháº¥y cÃ³ vÃ i cáº¥u hÃ¬nh nhÆ° sau:</p>
<pre><code class="language-text">-XX:MinHeapFreeRatio
-XX:MaxHeapFreeRatio
-XX:G1MaxUncommittedCapacity
</code></pre>
<p>Tuy nhiÃªn mang vÃ o xÃ i thá»­ thÃ¬ cÃ³ option khÃ´ng Ä‘Æ°á»£c há»— trá»£, cÃ²n láº¡i thÃ¬ khÃ´ng hoáº¡t Ä‘á»™ng.</p>
<p>Cuá»‘i cÃ¹ng nghÄ© láº¡i tháº¥y <code>Heap</code> xÃ i Ã­t quÃ¡, mÃ¬nh giáº£m pháº§n <code>reserved</code> cá»§a <code>Heap</code> xuá»‘ng cÃ²n <code>512MB</code> báº±ng cÃ¡ch sá»­ dá»¥ng:</p>
<pre><code>-XX:MaxRAMFraction=4
</code></pre>
<p>VÃ  káº¿t quáº£ thÃ¬ bá»™ nhá»› cá»§a toÃ n á»©ng dá»¥ng Ä‘Ã£ giáº£m xuá»‘ng má»©c an toÃ n.</p>
<ul>
<li>BÃªn trÃ¡i: service container.</li>
<li>BÃªn pháº£i: istio-proxy container.</li>
</ul>
<p><img src="img/jvm_memory_after_tuning.png" alt="after_tuning" /></p>
<p>Tuy nhiÃªn, sau vÃ i ngÃ y thÃ¬ á»©ng dá»¥ng cÃ³ xu hÆ°á»›ng tÄƒng cháº­m bá»™ nhá»›, mÃ¬nh xem thá»­ láº¡i vá» native memory tracking thÃ¬ tháº¥y cÃ¡c pháº§n trong JVM report khÃ´ng khÃ¡c nhiá»u láº¯m, váº­y nguyÃªn nhÃ¢n náº±m á»Ÿ pháº§n khÃ¡c.</p>
<h2 id="off-heap-memory">Off-heap memory</h2>
<p>Thá»±c sá»± heap chá»‰ lÃ  má»™t pháº§n trong tá»•ng bá»™ nhá»› cá»§a JVM vÃ  Ä‘Æ°á»£c quáº£n lÃ½ trá»±c tiáº¿p bá»Ÿi JVM, cÃ²n má»™t sá»‘ pháº§n native memory khÃ¡c khÃ´ng Ä‘Æ°á»£c thá»ƒ hiá»‡n trong bÃ¡o cÃ¡o cá»§a JVM, vÃ­ dá»¥ nhÆ°:</p>
<ul>
<li>MappedByteBuffer (Mapped files).</li>
<li>Native libraries allocations (cÃ¡c thÆ° viá»‡n C).</li>
<li>Malloc overhead</li>
</ul>
<p>Äá»ƒ theo dÃµi cÃ¡c pháº§n nÃ y thÃ¬ cÃ³ thá»ƒ sá»­ dá»¥ng cÃ´ng cá»¥ <code>pmap</code>.</p>
<p>NhÃ¬n vá» tá»•ng quan thÃ¬ tá»•ng bá»™ nhá»› cá»§a container sáº½ bao gá»“m cÃ¡c pháº§n sau:</p>
<pre><code>Total memory = Heap + GC + Metaspace + Code Cache + Symbol tables
               + Compiler + Other JVM structures + Thread stacks
               + Direct buffers + Mapped files +
               + Native libraries allocations + Malloc overhead
               + ...
</code></pre>
<p>Sáº½ cáº§n tiáº¿p tá»¥c nghiÃªn cá»©u vá» pháº§n <code>Off-heap memory</code> nÃ y trong cÃ¡c bÃ i sau, vÃ¬ Ä‘Ã¢y lÃ  chá»§ Ä‘á» phá»©c táº¡p, cáº§n pháº£i Ã´n láº¡i kiáº¿n thá»©c quáº£n lÃ½ bá»™ nhá»› trong há»‡ Ä‘iá»u hÃ nh ná»¯a ğŸ˜³, Ä‘iá»ƒm danh sÆ¡ sÆ¡ qua lÃ  tháº¥y cáº§n xem thÃªm vá»:</p>
<ul>
<li>Virtual memory vs Physical memory.</li>
<li>Memory paging.</li>
<li>Resident Set Size (RSS).</li>
<li>Cgroup memory limit.</li>
</ul>
<p>VÃ  bash script Ä‘á»ƒ mÃºa ná»¯a :)).</p>
<h2 id="tong-ket">Tá»•ng káº¿t</h2>
<p>Qua quÃ¡ trÃ¬nh tÃ¬m hiá»ƒu nÃ y, nháº­n ra Ä‘Æ°á»£c váº¥n Ä‘á» náº¯m Ä‘Æ°á»£c lÃ½ thuyáº¿t lÃ  cá»±c kÃ¬ quan trá»ng, cÃ³ nhá»¯ng thá»© nhÃ¬n váº­y nhÆ°ng khÃ´ng pháº£i váº­y, vÃ­ dá»¥ pháº§n <code>committed</code> memory cá»§a stack á»Ÿ Java 8.</p>
<p>Hiá»ƒu Ä‘Æ°á»£c tá»•ng thá»ƒ cÃ¡c vÃ¹ng nhá»› nÃ y cÅ©ng giÃºp Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh lÃ  xin thÃªm RAM cho service hay lÃ  tá»‘i Æ°u láº¡i á»©ng dá»¥ng.</p>
<p><img src="img/compare-go-java-joke.png" alt="compare-go-java-joke" /></p>
<h2 id="tham-khao">Tham kháº£o</h2>
<ul>
<li><a href="https://blog.arkey.fr/2020/11/30/off-heap-reconnaissance/">https://blog.arkey.fr/2020/11/30/off-heap-reconnaissance/</a></li>
<li><a href="https://dzone.com/articles/how-much-memory-does-a-java-thread-take">https://dzone.com/articles/how-much-memory-does-a-java-thread-take</a></li>
<li><a href="https://www.baeldung.com/linux/resident-set-vs-virtual-memory-size">https://www.baeldung.com/linux/resident-set-vs-virtual-memory-size</a></li>
<li>ChatGPT, Gemini AI</li>
</ul>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/jvm.html'>jvm</a><a class='topic-tag' href='/tags/java.html'>java</a></div>
      <!-- <div class="copyright">
                Báº¡n Ä‘Æ°á»£c toÃ n quyá»n chia sáº», trÃ­ch dáº«n hoáº·c copy, post láº¡i, nhÆ°ng vui lÃ²ng ghi rÃµ nguá»“n, tÃ¡c giáº£ vÃ  khÃ´ng lÃ m thay Ä‘á»•i ná»™i dung bÃ i viáº¿t. Náº¿u khÃ´ng lÃ m váº­y, thÃ¬ OK, cÅ©ng ko sao, sáº½ cÃ³ thiÃªn lÃ´i thay ta dÃ²m ngÃ³ nhÃ  ngÆ°Æ¡i. ğŸ˜ˆ
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>