<html>

<head>
  <title>Redis transaction note | Linh tinh</title>
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html;">
  <meta name=viewport content="initial-scale=1.0 maximum-scale=1.0">
  <meta property='og:image' content='https://melancholy.com/img/default.jpg'>
  <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
  <link rel="manifest" href="../manifest.json">
  <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700&amp;subset=latin-ext,vietnamese"
    rel="stylesheet">
  <!-- <link href="../css/theme.css?t=" rel="stylesheet" type="text/css"> -->
  <link href="/css/theme.css" rel="stylesheet" type="text/css">
  <!-- <link href="/css/gruvbox-dark.css" rel="stylesheet" type="text/css"> -->
  <link rel="stylesheet" href="../css/highlight/tomorrow.css">
  <link rel="stylesheet" href="../css/fontello.css">
  <link rel="stylesheet" href="../emoji/css/emoji.dist.css">
  <link rel="stylesheet" href="../emoji/css/emojione.min.css">
  <link rel="stylesheet" href="../emoji/css/messenger.min.css">
  <link rel="stylesheet" href="../emoji/css/thinking.ext.css">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css"> -->
  <script src="../js/highlight.min.js"></script>
  <script src="../js/autosizing.js"></script>
  <script src="../js/fetch.js"></script>
  <script src="../js/toc.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    hljs.highlightAll();
  </script>
</head>

<body>
  <div class="header">
    <a href="/"><span class="avatar"></span><span class="header-link">Linh tinh</span></a>
  </div>
  <div class="container has-toc navigation-box">
            <p><a href="/">&larr; Quay v·ªÅ trang ch·ªß</a></p>
        </div>
  <div class="container has-toc">
    <div class="table-of-contents">
      <div class="toc-title">Table of Contents</div><ul class="toc-list">  <li><a href="#vn" class="toc-link toc-level-2"><span class="toc-hash">#</span> V·∫•n ƒë·ªÅ</a></li>
  <li><a href="#redis-transaction" class="toc-link toc-level-2"><span class="toc-hash">#</span> Redis transaction</a></li>
    <li><a href="#watch" class="toc-link toc-level-3"><span class="toc-hash">#</span> WATCH</a></li></ul>
    </div>
    <div class="main">
      <h1>Redis transaction note</h1>
      <h2><a href="#v·∫•n-ƒë·ªÅ" aria-hidden="true" class="anchor" id="v·∫•n-ƒë·ªÅ"></a>V·∫•n ƒë·ªÅ</h2>
<p>C√≥ 1 API tr·∫£ ra qu√° nhi·ªÅu l·ªói internal server error, m√¨nh ki·ªÉm tra th√¨ th·∫•y client go c·ªßa redis hi·ªÉn th·ªã l·ªói nil message, t√¨m hi·ªÉu s√¢u h∆°n th√¨ th·∫•y c√≥ v·∫ª nh∆∞ transaction kh√¥ng ƒë∆∞·ª£c th·ª±c thi, sau khi ƒë·ªçc l√Ω thuy·∫øt l·∫°i th√¨ th·∫•y c√≥ v√†i tr∆∞·ªùng h·ª£p transaction kh√¥ng ƒë∆∞·ª£c th·ª±c thi v√† m√¨nh c·ªë ch·ª©ng minh ƒëi·ªÅu ƒë√≥ nh∆∞ng ban ƒë·∫ßu kh√¥ng ƒë∆∞·ª£c, mang l√™n github h·ªèi (<a href="https://github.com/redis/rueidis/discussions/571#discussioncomment-9784180">https://github.com/redis/rueidis/discussions/571#discussioncomment-9784180</a>), v√† 1 tu·∫ßn sau may m·∫Øn m√¨nh ƒë√£ t√¨m ra v·∫•n ƒë·ªÅ.</p>
<h2><a href="#redis-transaction" aria-hidden="true" class="anchor" id="redis-transaction"></a>Redis transaction</h2>
<p>V·ªõi m√¥ h√¨nh single thread, Redis cung c·∫•p t√≠nh kh·∫£ tu·∫ßn t·ª± ho√° (serializable) v√† t√≠nh c√¥ l·∫≠p (isolation) cho m·ªôt transaction, ƒë·ªÉ th·ª±c thi m·ªôt transaction, s·ª≠ d·ª•ng c·∫∑p l·ªánh <code>MULTI</code> v√† <code>EXEC</code> ho·∫∑c <code>DISCARD</code> ƒë·ªÉ hu·ª∑, c·ª• th·ªÉ:</p>
<ul>
<li><code>MULTI</code> : l·ªánh b·∫Øt ƒë·∫ßu ƒë·ªÉ chu·∫©n b·ªã cho m·ªôt transaction</li>
<li>C√°c command c·∫ßn th·ª±c thi, thay v√¨ th·ª±c thi ngay l·∫≠p t·ª©c th√¨ Redis s·∫Ω validate v√†  b·ªè v√†o queue</li>
<li><code>EXEC</code> : b·∫Øt ƒë·∫ßu th·ª±c thi t·∫•t c·∫£ c√°c c√¢u l·ªánh sau c√¢u l·ªánh trong queue</li>
<li><code>DISCARD</code> : hu·ª∑ b·ªè t·∫•t c·∫£ c√¢u l·ªánh trong queue v√† tho√°t transaction</li>
</ul>
<p>V·ªõi c√°ch ho·∫°t ƒë·ªông nh∆∞ tr√™n v√† m√¥ h√¨nh single thread, Redis ƒë·∫£m b·∫£o ƒë∆∞·ª£c t√≠nh c√¥ l·∫≠p c·ªßa m·ªôt transaction, c√¢u l·ªánh ƒë·∫øn t·ª´ m·ªôt client kh√°c s·∫Ω <strong>kh√¥ng ƒë∆∞·ª£c th·ª±c thi</strong> ·ªü gi·ªØa m·ªôt transaction.</p>
<p>Nghe c√≥ v·∫ª ·ªïn, tuy nhi√™n m·ªôt transaction th√¥ng th∆∞·ªùng s·∫Ω c√≥ m·ªôt pattern nh∆∞ <code>get ‚Üí compute ‚Üí set</code>, input v√† output c·ªßa c√°c b∆∞·ªõc s·∫Ω ph·ª• thu·ªôc l·∫´n nhau, v√† ch√∫ng ta kh√¥ng th·ªÉ l√†m ƒëi·ªÅu n√†y trong Redis üòë, do ƒë√≥, h√†nh ƒë·ªông <code>get</code> v√† <code>set</code> s·∫Ω kh√¥ng mang t√≠nh <code>atomic</code> , gi√° tr·ªã ƒë∆∞·ª£c get ra l√∫c ƒë·∫ßu ƒë√£ b·ªã thay ƒë·ªïi tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu th·ª±c hi·ªán b∆∞·ªõc sau. ·ªû RDBMS, k·∫øt qu·∫£ cu·ªëi c√πng c·ªßa tr∆∞·ªùng h·ª£p n√†y s·∫Ω tu·ª≥ thu·ªôc v√†o m·ª©c ƒë·ªô c√¥ l·∫≠p c·ªßa m·ªôt transaction, c√≥ th·ªÉ ghi ƒë√®, c√≥ th·ªÉ rollback d·ªØ li·ªáu, tuy nhi√™n v√¨ ƒë·ªô ph·ª©c t·∫°p v√† hi·ªáu nƒÉng, Redis kh√¥ng h·ªó tr·ª£ rollback d·ªØ li·ªáu v√† cung c·∫•p m·ªôt c∆° ch·∫ø kh√°c, ƒë√≥ l√† <code>CAS: check-and-set</code>.</p>
<h3><a href="#watch" aria-hidden="true" class="anchor" id="watch"></a>WATCH</h3>
<p>L·ªánh <code>WATCH</code> cho ph√©p Redis theo d√µi gi√° tr·ªã m·ªôt ho·∫∑c nhi·ªÅu key ƒë·∫øn l√∫c nh·∫≠n ƒë∆∞·ª£c l·ªánh <code>EXEC</code> , nh∆∞ v·∫≠y v·ªÅ c∆° b·∫£n, c√°c l·ªánh s·∫Ω ƒë∆∞·ª£c g·ªçi theo th·ª© t·ª±: <code>WATCH</code> ‚Üí <code>GET COMMAND</code> ‚Üí <code>MULTI</code> ‚Üí <code>COMMAND1</code> ‚Üí <code>COMMAND 2</code> ‚Üí ‚Ä¶ ‚Üí <code>EXEC</code>, khi nh·∫≠n v√† th·ª±c thi l·ªánh <code>EXEC</code>, Redis s·∫Ω ki·ªÉm tra xem gi√° tr·ªã c·ªßa c√°c key ƒë∆∞·ª£c theo d√µi c√≥ ƒë∆∞·ª£c thay ƒë·ªïi hay kh√¥ng, n·∫øu c√≥ th√¨ transaction s·∫Ω b·ªã aborted v√† Redis tr·∫£ v·ªÅ <code>empty message</code> v·ªõi n·ªôi dung <code>_\r\n</code>, th√¥ng th∆∞·ªùng c√°c client s·∫Ω x·ª≠ l√Ω message n√†y nh∆∞ m·ªôt error v·ªõi <code>nil message</code>.</p>
<p>Khi <code>EXEC</code> ƒë∆∞·ª£c g·ªçi ho·∫∑c connection ƒë∆∞·ª£c ƒë√≥ng, t·∫•t c·∫£ c√°c key s·∫Ω ƒë∆∞·ª£c <code>UNWATCH</code> .</p>
<p>Nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p ·ªü ƒë·∫ßu b√†i vi·∫øt, m√¨nh c·ªë ch·ª©ng minh l√Ω thuy·∫øt tr√™n, nh∆∞ng kh√¥ng ƒë∆∞·ª£c :v, sau ƒë√≥ b·∫±ng c√°ch reproduce l·∫°i, m√¨nh ƒë√£ th·∫•y ƒë∆∞·ª£c v·∫•n ƒë·ªÅ n·∫±m ·ªü l·ªánh <code>WATCH</code> , v√† <strong>·ªü b·∫£n th√¢n m√¨nh üòêüòêüòêüòêüòêüòêüòêüòêüòê</strong>.</p>
<p>M√¨nh xin tr√≠ch d·∫´n docs t·ª´ Redis (<a href="https://redis.io/docs/latest/develop/interact/transactions/#watch-explained">https://redis.io/docs/latest/develop/interact/transactions/#watch-explained</a>):</p>
<blockquote>
<p>WATCH can be called multiple times. Simply all the WATCH calls will
have the effects to watch for changes starting from the call, up to
the moment EXEC is called. You can also send any number of keys to a
single WATCH call. <br/><br/>
When EXEC is called, all keys are UNWATCHed, regardless of whether
the transaction was aborted or not.  Also when a client connection is
closed, everything gets UNWATCHed. <br/><br/>
It is also possible to use the UNWATCH command (without arguments)
in order to flush all the watched keys. Sometimes this is useful as we
optimistically lock a few keys, since possibly we need to perform a
transaction to alter those keys, but after reading the current content
of the keys we don't want to proceed.  When this happens we just call
UNWATCH so that the connection can already be used freely for new
transactions.</p>
</blockquote>
<p>M√¨nh ch·ªâ t·∫≠p trung v√†o ƒëo·∫°n ƒë·∫ßu ti√™n m√† kh√¥ng ƒë·ªçc kƒ© ƒëo·∫°n th·ª© 3, ƒëo·∫°n ƒë·∫ßu ti√™n l√†m m√¨nh hi·ªÉu nh·∫ßm l·ªánh <code>WATCH</code> s·∫Ω reset l·∫°i state c·ªßa key ƒë∆∞·ª£c theo d√µi, tuy nhi√™n, theo ƒëo·∫°n th·ª© 3 v√† nh·ªØng g√¨ m√¨nh test l·∫°i, th√¨ trong c√πng 1 client connection, n·∫øu g·ªçi nhi·ªÅu l·ªánh <code>WATCH</code> li√™n ti·∫øp tr√™n c√πng 1 key th√¨ ch·ªâ c√≥ l·ªánh ƒë·∫ßu ti√™n ƒë∆∞·ª£c th·ª±c thi.</p>
<p>V√† tr√πng h·ª£p thay, Redis client m√¨nh ƒëang d√πng reuse l·∫°i connection c·ªßa nh·ªØng request tr∆∞·ªõc, ƒë∆°n gi·∫£n b·ªüi v√¨ th∆∞ vi·ªán n√†y l∆∞u tr·ªØ connection pool trong m·ªôt array v√† m·∫∑c ƒë·ªãnh, connection ƒë·∫ßu ti√™n ƒë∆∞·ª£c l·∫•y ƒë·ªÉ th·ª±c thi r·ªìi ƒë∆∞·ª£c tr·∫£ l·∫°i v·ªÅ pool. ƒê√≥ l√† l√Ω do v√¨ sao m√¨nh g·ªçi t·ª´ng API b·∫±ng postman th√¨ th·∫•y r·∫•t nhi·ªÅu l·ªói 500.</p>
<p>V√≠ d·ª•, t·ª´ k·∫øt qu·∫£ c·ªßa l·ªánh <code>MONITOR</code> c·ªßa Redis, <code>connection ID 38900</code> th·ª±c hi·ªán t·∫•t c·∫£ c√°c transaction ƒë∆∞·ª£c y√™u c·∫ßu, v√† b·∫°n c√≥ th·ªÉ th·∫•y c√≥ nhi·ªÅu l·ªánh <code>WATCH</code> li√™n ti·∫øp nhau, l·ªánh <code>WATCH</code> tr∆∞·ªõc <code>MULTI-EXEC</code> kh√¥ng c√≥ √Ω nghƒ©a n√™n transaction b·ªã aborted.</p>
<pre><code class="language-bash">2024-06-15 14:27:12.811820 [0 172.24.0.1:58706] &quot;ZADD&quot; &quot;watched_key&quot; &quot;INCR&quot; &quot;-1&quot; &quot;127.0.0.1&quot;
2024-06-15 14:27:12.816681 [0 172.24.0.1:58654] &quot;ZREM&quot; &quot;another_key&quot; &quot;127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.823212 [0 172.24.0.1:58674] &quot;ZSCORE&quot; &quot;watched_key&quot; &quot;127.0.0.1&quot;
2024-06-15 14:27:12.831299 [0 172.24.0.1:38920] &quot;EVALSHA&quot; &quot;7726c7be95e2a0ed082ec1da1e26b562f5c8903f&quot; &quot;1&quot; &quot;2:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot; &quot;\x84\xa2\x9f\x13\x85\x1c\xe9\\\xcc\a\x82D\xa4\x8a\xd7B\xa8\xbfK\xfd\xe2\x13\xaaX&quot; &quot;1718461637799&quot;
2024-06-15 14:27:12.831648 [0 lua] &quot;GET&quot; &quot;2:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.831702 [0 lua] &quot;DEL&quot; &quot;2:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.831804 [0 172.24.0.1:58650] &quot;EVALSHA&quot; &quot;7726c7be95e2a0ed082ec1da1e26b562f5c8903f&quot; &quot;1&quot; &quot;0:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot; &quot;\x84\xa2\x9f\x13\x85\x1c\xe9\\\xcc\a\x82D\xa4\x8a\xd7B\xa8\xbfK\xfd\xe2\x13\xaaX&quot; &quot;1718461637799&quot;
2024-06-15 14:27:12.831908 [0 lua] &quot;GET&quot; &quot;0:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.831932 [0 lua] &quot;DEL&quot; &quot;0:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.831993 [0 172.24.0.1:58650] &quot;EVALSHA&quot; &quot;7726c7be95e2a0ed082ec1da1e26b562f5c8903f&quot; &quot;1&quot; &quot;1:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot; &quot;\x84\xa2\x9f\x13\x85\x1c\xe9\\\xcc\a\x82D\xa4\x8a\xd7B\xa8\xbfK\xfd\xe2\x13\xaaX&quot; &quot;1718461637799&quot;
2024-06-15 14:27:12.832003 [0 lua] &quot;GET&quot; &quot;1:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.832006 [0 lua] &quot;DEL&quot; &quot;1:127.0.0.1-d9cace95-2a26-4d94-aa24-1a1d2c381a82&quot;
2024-06-15 14:27:12.904419 [0 172.24.0.1:38900] &quot;ZSCORE&quot; &quot;watched_key&quot; &quot;127.0.0.1&quot;
2024-06-15 14:27:12.905439 [0 172.24.0.1:38900] &quot;WATCH&quot; &quot;watched_key&quot;
2024-06-15 14:27:12.906484 [0 172.24.0.1:38900] &quot;ZRANGEBYSCORE&quot; &quot;watched_key&quot; &quot;-inf&quot; &quot;9&quot; &quot;LIMIT&quot; &quot;0&quot; &quot;1&quot;
2024-06-15 14:27:12.907474 [0 172.24.0.1:38900] &quot;ZSCORE&quot; &quot;watched_key&quot; &quot;127.0.0.1&quot;
2024-06-15 14:27:12.908419 [0 172.24.0.1:38900] &quot;MULTI&quot;
2024-06-15 14:27:12.909881 [0 172.24.0.1:38900] &quot;EXEC&quot;
2024-06-15 14:27:12.910860 [0 172.24.0.1:38900] &quot;ZSCORE&quot; &quot;watched_key&quot; &quot;127.0.0.1&quot;
2024-06-15 14:27:13.244464 [0 172.24.0.1:35638] &quot;keys&quot; &quot;turn/origin/*&quot;
2024-06-15 14:27:13.244489 [0 172.24.0.1:35620] &quot;keys&quot; &quot;turn/origin/*&quot;
2024-06-15 14:27:13.244900 [0 172.24.0.1:35634] &quot;keys&quot; &quot;turn/origin/*&quot;
2024-06-15 14:27:13.244920 [0 172.24.0.1:35636] &quot;keys&quot; &quot;turn/origin/*&quot;
2024-06-15 14:27:13.245474 [0 172.24.0.1:35630] &quot;keys&quot; &quot;turn/origin/*&quot;
2024-06-15 14:27:13.804457 [0 172.24.0.1:58674] &quot;ZRANGEBYSCORE&quot; &quot;another_key&quot; &quot;-inf&quot; &quot;1718461633&quot; &quot;LIMIT&quot; &quot;0&quot; &quot;100&quot;
</code></pre>
<p>‚Üí V√¨ v·∫≠y, ch·ªâ c·∫ßn <code>UNWATCH</code> nh·ªØng key ƒë√£ ƒë∆∞·ª£c <code>WATCH</code> n·∫øu ch√∫ng ta kh√¥ng g·ªçi <code>EXEC</code> .</p>

      <div class='other-tags'><b>Tags:</b> <a class='topic-tag' href='/tags/redis.html'>redis</a></div>
      <!-- <div class="copyright">
                B·∫°n ƒë∆∞·ª£c to√†n quy·ªÅn chia s·∫ª, tr√≠ch d·∫´n ho·∫∑c copy, post l·∫°i, nh∆∞ng vui l√≤ng ghi r√µ ngu·ªìn, t√°c gi·∫£ v√† kh√¥ng l√†m thay ƒë·ªïi n·ªôi dung b√†i vi·∫øt. N·∫øu kh√¥ng l√†m v·∫≠y, th√¨ OK, c≈©ng ko sao, s·∫Ω c√≥ thi√™n l√¥i thay ta d√≤m ng√≥ nh√† ng∆∞∆°i. üòà
                </div> -->
    </div>
  </div>
  <div class="footer">
    <p>Created with <i class="em em-coffee"></i> <a href="http://github.com/huytd/ristretto-rs">ristretto.rs</a></p>
    <div class="social">
      <a target="_blank" href="https://github.com/dntam00"><i class="icon-github-squared"></i></a>
      <a target="_blank" href="https://www.linkedin.com/in/dang-ngoc-tam/"><i class="icon-linkedin-squared"></i></a>
    </div>
  </div>
  <script type="text/javascript" async=""
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            skipTags: ["script","noscript","style","textarea", "code"],
            ignoreClass: ["comment", "comment-list"]
          }
        });
  </script>
</body>

</html>